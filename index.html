<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sales & GS Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin: 0;
    padding: 0;
    background: #06121f;
    color: #e8f2ff;
    font-family: "Poppins", sans-serif;
    overflow-x: hidden;
}

/* HEADER */
.header {
    width: 100%;
    padding: 22px 28px;
    background: rgba(0,0,0,0.25);
    border-bottom: 1px solid #0c1d33;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 0 20px #003b99 inset;
}

.header-title {
    font-size: 32px;
    font-weight: 700;
    text-shadow: 0 0 12px #2e88ff;
}

.live-badge {
    background: #22c55e;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 14px;
    color: white;
    box-shadow: 0 0 10px #22c55e;
}

/* LAYOUT */
.dashboard {
    display: flex;
    height: calc(100vh - 80px);
}

/* SIDEBAR */
.sidebar {
    width: 230px;
    background: #07182c;
    border-right: 1px solid #0d2646;
    padding-top: 15px;
}

.sidebar button {
    width: 90%;
    margin: 10px auto;
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: #0c2544;
    color: #c9dbff;
    font-size: 15px;
    cursor: pointer;
    display: block;
    transition: 0.2s;
}

.sidebar button.active {
    background: #1464ff;
    color: white;
    box-shadow: 0 0 10px #1464ff;
}

.sidebar button:hover {
    background: #0f2c55;
}

/* MAIN CONTENT */
.main {
    flex-grow: 1;
    padding: 20px 30px;
    overflow-y: auto;
}

/* SUB TABS */
.subtabs {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
}

.subtabs button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    background: #0a1a33;
    color: #b7cff7;
    cursor: pointer;
}

.subtabs button.active {
    background: #195bff;
    color: white;
}

/* CARDS */
.cards {
    display: flex;
    gap: 18px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.card {
    background: #0b1c33;
    border-radius: 14px;
    padding: 25px;
    width: 220px;
    text-align: center;
    box-shadow: 0 0 10px #002b80 inset;
    cursor: pointer;
    transition: 0.2s;
}

.card:hover {
    box-shadow: 0 0 12px #195bff;
}

.card-title {
    font-size: 15px;
    opacity: 0.8;
}

.card-value {
    margin-top: 10px;
    font-size: 36px;
    font-weight: 700;
}

/* CHART CONTAINER */
.chart-box {
    background: #0b1c33;
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 25px;
    width: 48%;
    min-height: 330px;
    box-shadow: 0 0 10px #002b80 inset;
}

.chart-row {
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
}

/* TABLE */
.table-container {
    margin-top: 25px;
    background: #0b1c33;
    padding: 25px;
    border-radius: 16px;
    box-shadow: 0 0 10px #002b80 inset;
}

table {
    width: 100%;
    border-collapse: collapse;
}

table th {
    background: #0f2a55;
    padding: 10px;
    text-align: left;
    color: #d9e8ff;
}

table td {
    padding: 9px;
    border-bottom: 1px solid #0e2747;
    color: #bfd6ff;
}

/* STATUS BADGES */
.status-badge {
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: #fff;
}
.status-badge.good { background: #22c55e; }
.status-badge.warn { background: #f1c40f; }
.status-badge.bad { background: #dc2626; }

/* HIDE SECTIONS */
.section { display: none; }
.section.active { display: block; }
</style>
</head>

<body>

<div class="header">
    <div class="header-title">Sales & GS Dashboard</div>
    <div class="live-badge">✔ Live — Google Sheets</div>
</div>

<div class="dashboard">

    <div class="sidebar">
        <button id="btnSales" class="active">Sales</button>
        <button id="btnGS">GS Performance</button>
        <button id="btnDetails">Details</button>
    </div>

    <div class="main">

        <!-- SALES SECTION -->
        <div id="sectionSales" class="section active">

            <div class="subtabs">
                <button id="tabSalesOverview" class="active">Sales Overview</button>
                <button id="tabSalesRep">Sales Rep</button>
            </div>

            <!-- SALES OVERVIEW -->
            <div id="salesOverview" class="section active">

                <div class="cards">
                    <div class="card" id="cardAssigned">
                        <div class="card-title">Assigned</div>
                        <div class="card-value" id="valAssigned">0</div>
                    </div>

                    <div class="card" id="cardAccepted">
                        <div class="card-title">Accepted</div>
                        <div class="card-value" id="valAccepted">0</div>
                    </div>

                    <div class="card" id="cardReverted">
                        <div class="card-title">Reverted</div>
                        <div class="card-value" id="valReverted">0</div>
                    </div>

                    <div class="card" id="cardGSTransferred">
                        <div class="card-title">Transferred to GS</div>
                        <div class="card-value" id="valGSTransferred">0</div>
                    </div>

                    <div class="card" id="cardCOE">
                        <div class="card-title">COE</div>
                        <div class="card-value" id="valCOE">0</div>
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Assigned Trend</h3>
                        <canvas id="chartAssigned"></canvas>
                    </div>

                    <div class="chart-box">
                        <h3>Accepted Trend</h3>
                        <canvas id="chartAccepted"></canvas>
                    </div>
                </div>

            </div>

            <!-- SALES REP PAGE -->
            <div id="salesRepPage" class="section">

                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Sales Rep Comparison</h3>
                        <canvas id="chartSalesRepAssign"></canvas>
                    </div>

                    <div class="chart-box">
                        <h3>GS Transfers</h3>
                        <canvas id="chartSalesRepGST"></canvas>
                    </div>
                </div>

            </div>

        </div>

        <!-- GS PERFORMANCE SECTION -->
        <div id="sectionGS" class="section">

            <div class="subtabs">
                <button id="tabGSOverview" class="active">GS Overview</button>
                <button id="tabGSAlerts">Alerts</button>
            </div>

            <!-- GS OVERVIEW -->
            <div id="gsOverview" class="section active">

                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Full Offer Trend</h3>
                        <canvas id="chartFullOffer"></canvas>
                    </div>

                    <div class="chart-box">
                        <h3>COE Trend</h3>
                        <canvas id="chartCOETrend"></canvas>
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Visa Lodged Trend</h3>
                        <canvas id="chartVisaLodged"></canvas>
                    </div>

                    <div class="chart-box">
                        <h3>Visa Obtained Trend</h3>
                        <canvas id="chartVisaObtained"></canvas>
                    </div>
                </div>

            </div>

            <!-- GS ALERTS -->
            <div id="gsAlerts" class="section">

                <div class="table-container">
                    <h3>GS Stuck Cases</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Client Name</th>
                                <th>GS Lead</th>
                                <th>Stage</th>
                                <th>Days Stuck</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="gsAlertsBody"></tbody>
                    </table>
                </div>

            </div>

        </div>

        <!-- DETAILS SECTION -->
        <div id="sectionDetails" class="section">

            <div class="table-container">
                <h3>Details</h3>
                <table>
                    <thead id="detailsHead"></thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>

        </div>

    </div>
</div>

<!-- SCRIPT STARTS HERE -->
<script>
    /*-----------------------------------
    API URL
------------------------------------*/
const API_URL = "https://salesdashboard.ashishoct34.workers.dev/";

/*-----------------------------------
    GLOBAL DATA STORAGE
------------------------------------*/
let fullData = {};  // raw dataset
let flatList = [];  // flattened list for details table

/*-----------------------------------
    FETCH DATA FROM API
------------------------------------*/
async function loadData() {
    try {
        const res = await fetch(API_URL);
        const json = await res.json();

        if (!json.success) throw new Error("API returned error");

        fullData = json.data;
        flatList = Object.values(fullData).flat();

        renderAll();
    } catch (err) {
        console.error("API Error:", err);
    }
}

/*-----------------------------------
    PARSE DATE SAFE
------------------------------------*/
function safeDate(str) {
    if (!str || str.trim() === "") return null;
    const d = new Date(str);
    return isNaN(d) ? null : d;
}

/*-----------------------------------
    DAYS BETWEEN
------------------------------------*/
function daysBetween(a, b = new Date()) {
    const d1 = safeDate(a);
    const d2 = safeDate(b);
    if (!d1 || !d2) return null;
    return Math.floor((d2 - d1) / (1000 * 60 * 60 * 24));
}

/*-----------------------------------
    GS STAGE DETECTION
------------------------------------*/
function getGSStage(item) {
    if (!item["transferred to gs date"]) return null;

    if (!item["full offer date"]) return "Waiting Full Offer";
    if (!item["coe obtained date"]) return "Waiting COE";
    if (!item["visa lodged date"]) return "Waiting Visa Lodgement";
    if (!item["visa obtained date"]) return "Waiting Visa Grant";

    return "Completed";
}

/*-----------------------------------
    COUNT HELPERS
------------------------------------*/
function countAssigned(list) {
    return list.filter(x => x["assigned date"]).length;
}

function countAccepted(list) {
    return list.filter(x => x["reason if reverted"] === "").length;
}

function countReverted(list) {
    return list.filter(x => x["reason if reverted"] && x["reason if reverted"] !== "").length;
}

function countGSTransferred(list) {
    return list.filter(x => x["transferred to gs date"]).length;
}

function countCOE(list) {
    return list.filter(x => x["coe obtained date"]).length;
}

/*-----------------------------------
    BUILD SALES OVERVIEW CARDS
------------------------------------*/
function buildOverviewCards() {
    const list = flatList;

    id("valAssigned").innerText       = countAssigned(list);
    id("valAccepted").innerText       = countAccepted(list);
    id("valReverted").innerText       = countReverted(list);
    id("valGSTransferred").innerText  = countGSTransferred(list);
    id("valCOE").innerText            = countCOE(list);
}

/*-----------------------------------
    CARD CLICK -> FILTER DETAILS
------------------------------------*/
function setupCardFilters() {
    id("cardAssigned").onclick = () => showFiltered("assigned date");
    id("cardAccepted").onclick = () => showFiltered("accepted");
    id("cardReverted").onclick = () => showFiltered("reverted");
    id("cardGSTransferred").onclick = () => showFiltered("transferred to gs date");
    id("cardCOE").onclick = () => showFiltered("coe obtained date");
}

function showFiltered(type) {
    openSection("sectionDetails");

    let rows = [];

    if (type === "accepted") {
        rows = flatList.filter(x => x["reason if reverted"] === "");
    } else if (type === "reverted") {
        rows = flatList.filter(x => x["reason if reverted"] && x["reason if reverted"] !== "");
    } else {
        rows = flatList.filter(x => x[type]);
    }

    renderDetails(rows);
}

/*-----------------------------------
    SALES REP COMPARISON CHARTS
------------------------------------*/
function buildSalesRepCharts() {
    const reps = Object.keys(fullData);

    const assignedCounts = reps.map(rep => countAssigned(fullData[rep]));
    const gstCounts       = reps.map(rep => countGSTransferred(fullData[rep]));

    buildBarChart("chartSalesRepAssign", reps, assignedCounts, "Assigned");
    buildBarChart("chartSalesRepGST", reps, gstCounts, "GS Transfers");
}

/*-----------------------------------
    GS ALERTS TABLE
    (SHOW ALL CASES — Your chosen A)
------------------------------------*/
function buildGSAlerts() {
    const tbody = id("gsAlertsBody");
    tbody.innerHTML = "";

    flatList.forEach(item => {
        const stage = getGSStage(item);
        if (!stage) return;

        let baseDate =
            stage === "Waiting Full Offer"       ? item["transferred to gs date"] :
            stage === "Waiting COE"              ? item["full offer date"] :
            stage === "Waiting Visa Lodgement"   ? item["coe obtained date"] :
            stage === "Waiting Visa Grant"       ? item["visa lodged date"] :
            null;

        if (!baseDate) return;

        const days = daysBetween(baseDate);

        // Status coloring
        let statusClass = days <= 1 ? "good" : days <= 5 ? "warn" : "bad";
        let statusName  = days <= 1 ? "On Track" : days <= 5 ? "Pending" : "Delayed";

        const row = `
        <tr>
            <td>${item["client name"] || ""}</td>
            <td>${item["gs lead"] || "N/A"}</td>
            <td>${stage}</td>
            <td>${days} days</td>
            <td><span class="status-badge ${statusClass}">${statusName}</span></td>
        </tr>`;

        tbody.insertAdjacentHTML("beforeend", row);
    });
}

/*-----------------------------------
    TREND CHARTS FOR SALES
------------------------------------*/
function groupByMonth(list, field) {
    const map = {};
    list.forEach(x => {
        const d = safeDate(x[field]);
        if (!d) return;
        const key = `${d.getFullYear()}-${d.getMonth()+1}`;
        map[key] = (map[key] || 0) + 1;
    });
    return map;
}

function buildSalesTrends() {
    const assigned = groupByMonth(flatList, "assigned date");
    const accepted = groupByMonth(flatList.filter(x => x["reason if reverted"] === ""), "assigned date");

    buildBarChartFromMap("chartAssigned", assigned);
    buildBarChartFromMap("chartAccepted", accepted);
}

/*-----------------------------------
    GS TRENDS (Full offer, COE, Visa)
------------------------------------*/
function buildGSTrends() {
    buildBarChartFromMap("chartFullOffer",
        groupByMonth(flatList, "full offer date"));

    buildBarChartFromMap("chartCOETrend",
        groupByMonth(flatList, "coe obtained date"));

    buildBarChartFromMap("chartVisaLodged",
        groupByMonth(flatList, "visa lodged date"));

    buildBarChartFromMap("chartVisaObtained",
        groupByMonth(flatList, "visa obtained date"));
}

/*-----------------------------------
    BAR CHART HELPERS
------------------------------------*/
function buildBarChart(idName, labels, values, labelName) {
    new Chart(document.getElementById(idName), {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: labelName,
                data: values,
                backgroundColor: "#3b82f6aa",
                borderColor: "#3b82f6",
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: "white" }}},
            scales: {
                x: { ticks: { color: "white" }},
                y: { ticks: { color: "white" }}
            }
        }
    });
}

function buildBarChartFromMap(idName, map) {
    const labels = Object.keys(map);
    const values = Object.values(map);

    new Chart(id(idName), {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label: "Count",
                data: values,
                backgroundColor: "#2563ebaa",
                borderColor: "#2563eb",
                borderWidth: 2,
                borderRadius: 8
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: "white" }}},
            scales: {
                x: { ticks: { color: "white" }},
                y: { ticks: { color: "white" }}
            }
        }
    });
}

/*-----------------------------------
    DETAILS TABLE
------------------------------------*/
function renderDetails(list) {
    const thead = id("detailsHead");
    const tbody = id("detailsBody");

    // Table headers (fixed)
    const cols = [
        "client name", "agentcis link", "assignee", "assigned date", "source",
        "assigned office", "sales rep", "reason if reverted",
        "transferred to gs date", "full offer date", "coe obtained date",
        "visa lodged date", "visa obtained date", "gs lead"
    ];

    thead.innerHTML = `
        <tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr>
    `;

    tbody.innerHTML = "";

    list.forEach(item => {
        const tr = `
            <tr>
                ${cols.map(c => `<td>${item[c] || ""}</td>`).join("")}
            </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", tr);
    });
}

/*-----------------------------------
    MAIN RENDER FUNCTION
------------------------------------*/
function renderAll() {
    buildOverviewCards();
    setupCardFilters();
    buildSalesRepCharts();
    buildSalesTrends();
    buildGSTrends();
    buildGSAlerts();
    renderDetails(flatList);
}

/*-----------------------------------
    HELPERS
------------------------------------*/
function id(x) { return document.getElementById(x); }
/*-----------------------------------
    SIDEBAR SECTION SWITCHING
------------------------------------*/
function openSection(sectionId) {
    // Sidebar buttons
    id("btnSales").classList.remove("active");
    id("btnGS").classList.remove("active");
    id("btnDetails").classList.remove("active");

    // Sections
    id("sectionSales").classList.remove("active");
    id("sectionGS").classList.remove("active");
    id("sectionDetails").classList.remove("active");

    // Activate selected
    if (sectionId === "sectionSales") {
        id("btnSales").classList.add("active");
    }
    if (sectionId === "sectionGS") {
        id("btnGS").classList.add("active");
    }
    if (sectionId === "sectionDetails") {
        id("btnDetails").classList.add("active");
    }

    id(sectionId).classList.add("active");
}

/*-----------------------------------
    SIDEBAR CLICK HANDLERS
------------------------------------*/
id("btnSales").addEventListener("click", () => {
    openSection("sectionSales");
    openSalesTab("salesOverview");
});

id("btnGS").addEventListener("click", () => {
    openSection("sectionGS");
    openGSTab("gsOverview");
});

id("btnDetails").addEventListener("click", () => {
    openSection("sectionDetails");
    renderDetails(flatList);
});

/*-----------------------------------
    SALES SUBTAB SWITCHING
------------------------------------*/
function openSalesTab(tabName) {
    id("tabSalesOverview").classList.remove("active");
    id("tabSalesRep").classList.remove("active");

    id("salesOverview").classList.remove("active");
    id("salesRepPage").classList.remove("active");

    if (tabName === "salesOverview") {
        id("tabSalesOverview").classList.add("active");
        id("salesOverview").classList.add("active");
    } else {
        id("tabSalesRep").classList.add("active");
        id("salesRepPage").classList.add("active");
    }
}

id("tabSalesOverview").onclick = () => openSalesTab("salesOverview");
id("tabSalesRep").onclick = () => openSalesTab("salesRep");

/*-----------------------------------
    GS SUBTAB SWITCHING
------------------------------------*/
function openGSTab(tabName) {
    id("tabGSOverview").classList.remove("active");
    id("tabGSAlerts").classList.remove("active");

    id("gsOverview").classList.remove("active");
    id("gsAlerts").classList.remove("active");

    if (tabName === "gsOverview") {
        id("tabGSOverview").classList.add("active");
        id("gsOverview").classList.add("active");
    } else {
        id("tabGSAlerts").classList.add("active");
        id("gsAlerts").classList.add("active");
    }
}

id("tabGSOverview").onclick = () => openGSTab("gsOverview");
id("tabGSAlerts").onclick = () => openGSTab("gsAlerts");

/*-----------------------------------
    DEFAULT LANDING PAGE
    (Sales Overview as you requested)
------------------------------------*/
openSection("sectionSales");
openSalesTab("salesOverview");

/*-----------------------------------
    INITIAL LOAD
------------------------------------*/
loadData();

</script>
</body>
</html>

