<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sales & GS Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* GLOBAL */
body {
    margin: 0;
    padding: 0;
    background: #06121f;
    color: #e8f2ff;
    font-family: "Poppins", sans-serif;
    overflow-x: hidden;
}

/* HEADER */
.header {
    width: 100%;
    padding: 22px 28px;
    background: rgba(0,0,0,0.25);
    border-bottom: 1px solid #0c1d33;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 0 20px #003b99 inset;
}

.header-title {
    font-size: 32px;
    font-weight: 700;
    text-shadow: 0 0 12px #2e88ff;
}

.live-badge {
    background: #22c55e;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 14px;
    color: white;
    box-shadow: 0 0 10px #22c55e;
}

/* LAYOUT */
.dashboard {
    display: flex;
    height: calc(100vh - 80px);
}

/* SIDEBAR */
.sidebar {
    width: 230px;
    background: #07182c;
    border-right: 1px solid #0d2646;
    padding-top: 15px;
}

.sidebar button {
    width: 90%;
    margin: 10px auto;
    padding: 12px;
    border: none;
    border-radius: 8px;
    background: #0c2544;
    color: #c9dbff;
    font-size: 15px;
    cursor: pointer;
    display: block;
    transition: 0.2s;
}

.sidebar button.active {
    background: #1464ff;
    color: white;
    box-shadow: 0 0 10px #1464ff;
}

.sidebar button:hover {
    background: #0f2c55;
}

/* MAIN */
.main {
    flex-grow: 1;
    padding: 20px 30px;
    overflow-y: auto;
}

/* SUBTABS */
.subtabs {
    display: flex;
    gap: 12px;
    margin-bottom: 20px;
}

.subtabs button {
    padding: 8px 16px;
    border-radius: 6px;
    border: none;
    background: #0a1a33;
    color: #b7cff7;
    cursor: pointer;
}

.subtabs button.active {
    background: #195bff;
    color: white;
}

/* CARDS */
.cards {
    display: flex;
    gap: 18px;
    margin-bottom: 25px;
    flex-wrap: wrap;
}

.card {
    background: #0b1c33;
    border-radius: 14px;
    padding: 25px;
    width: 220px;
    text-align: center;
    box-shadow: 0 0 10px #002b80 inset;
    cursor: pointer;
    transition: 0.2s;
}

.card:hover {
    box-shadow: 0 0 12px #195bff;
}

.card-title {
    font-size: 15px;
    opacity: 0.8;
}

.card-value {
    margin-top: 10px;
    font-size: 36px;
    font-weight: 700;
}

/* CHART ROW */
.chart-row {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
}

.chart-box {
    background: #0b1c33;
    padding: 20px;
    border-radius: 16px;
    width: 48%;
    min-height: 330px;
    box-shadow: 0 0 10px #002b80 inset;
}

/* TABLE */
.table-container {
    margin-top: 25px;
    background: #0b1c33;
    padding: 25px;
    border-radius: 16px;
    box-shadow: 0 0 10px #002b80 inset;
}

table {
    width: 100%;
    border-collapse: collapse;
}

table th {
    background: #0f2a55;
    padding: 10px;
    text-align: left;
    color: #d9e8ff;
}

table td {
    padding: 9px;
    border-bottom: 1px solid #0e2747;
    color: #bfd6ff;
}

/* STATUS BADGES */
.status-badge {
    padding: 5px 10px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 600;
    color: #fff;
}

.good { background: #22c55e; }
.warn  { background: #facc15; }
.bad   { background: #ef4444; }
.done  { background: #4ade80; }

/* SECTION HANDLING */
.section { display: none; }
.section.active { display: block; }
</style>
</head>

<body>

<div class="header">
    <div class="header-title">Sales & GS Dashboard</div>
    <div class="live-badge">✔ Live — Google Sheets</div>
</div>

<div class="dashboard">

    <!-- SIDEBAR -->
    <div class="sidebar">
        <button id="btnSales" class="active">Sales</button>
        <button id="btnGS">GS Performance</button>
        <button id="btnDetails">Details</button>
    </div>

    <!-- MAIN -->
    <div class="main">

        <!-- SALES SECTION -->
        <div id="sectionSales" class="section active">

            <div class="subtabs">
                <button id="tabSalesOverview" class="active">Sales Overview</button>
                <button id="tabSalesRep">Sales Rep</button>
            </div>

            <!-- SALES OVERVIEW -->
            <div id="salesOverview" class="section active">

                <div class="cards">
                    <div class="card" id="cardAssigned">
                        <div class="card-title">Assigned</div>
                        <div class="card-value" id="valAssigned">0</div>
                    </div>

                    <div class="card" id="cardAccepted">
                        <div class="card-title">Accepted</div>
                        <div class="card-value" id="valAccepted">0</div>
                    </div>

                    <div class="card" id="cardReverted">
                        <div class="card-title">Reverted</div>
                        <div class="card-value" id="valReverted">0</div>
                    </div>

                    <div class="card" id="cardGS">
                        <div class="card-title">Transferred to GS</div>
                        <div class="card-value" id="valGSTransferred">0</div>
                    </div>

                    <div class="card" id="cardCOE">
                        <div class="card-title">COE</div>
                        <div class="card-value" id="valCOE">0</div>
                    </div>
                </div>

                <!-- SALES CHARTS -->
                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Assigned Trend</h3>
                        <canvas id="chartAssigned"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>Accepted Trend</h3>
                        <canvas id="chartAccepted"></canvas>
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Reverted Trend</h3>
                        <canvas id="chartReverted"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>GS Transfers Trend</h3>
                        <canvas id="chartGSTransfers"></canvas>
                    </div>
                </div>

            </div>

            <!-- SALES REP TAB -->
            <div id="salesRepPage" class="section">
                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Sales Rep — Assigned</h3>
                        <canvas id="chartSalesRepAssign"></canvas>
                    </div>
                    <div class="chart-box">
                        <h3>Sales Rep — GS Transfers</h3>
                        <canvas id="chartSalesRepGST"></canvas>
                    </div>
                </div>
            </div>

        </div>

        <!-- GS SECTION -->
        <div id="sectionGS" class="section">

            <div class="subtabs">
                <button id="tabGSOverview" class="active">GS Overview</button>
                <button id="tabGSAlerts">Alerts</button>
            </div>

            <!-- GS OVERVIEW -->
            <div id="gsOverview" class="section active">

                <div class="cards">
                    <div class="card">
                        <div class="card-title">Total GS Cases</div>
                        <div class="card-value" id="gsTotal">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Full Offer Pending</div>
                        <div class="card-value" id="gsFullOfferPending">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">COE Pending</div>
                        <div class="card-value" id="gsCOEPending">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Visa Pending</div>
                        <div class="card-value" id="gsVisaPending">0</div>
                    </div>
                </div>

                <!-- GS CHARTS OPTION A -->
                <div class="chart-row">
                    <div class="chart-box">
                        <h3>GS Transfers Trend</h3>
                        <canvas id="chartGSTransfers2"></canvas>
                    </div>

                    <div class="chart-box">
                        <h3>Average Days to Full Offer</h3>
                        <canvas id="chartGSFullOfferDays"></canvas>
                    </div>
                </div>

                <div class="chart-row">
                    <div class="chart-box">
                        <h3>Average Days to COE</h3>
                        <canvas id="chartGSCOEDays"></canvas>
                    </div>

                    <div class="chart-box">
                        <h3>Average Days to Visa Lodged</h3>
                        <canvas id="chartGSVisaDays"></canvas>
                    </div>
                </div>
            </div>

            <!-- GS ALERTS -->
            <div id="gsAlerts" class="section">

                <div class="table-container">
                    <h3>GS Stuck Cases</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Client Name</th>
                                <th>GS Lead</th>
                                <th>Stage</th>
                                <th>Days Stuck</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="gsAlertsBody"></tbody>
                    </table>
                </div>

            </div>

        </div>

        <!-- DETAILS SECTION -->
        <div id="sectionDetails" class="section">

            <div class="table-container">
                <h3>Details</h3>
                <table>
                    <thead id="detailsHead"></thead>
                    <tbody id="detailsBody"></tbody>
                </table>
            </div>

        </div>

    </div>
</div>

<!-- SCRIPT START -->
<script>
/* API URL */
const API_URL = "https://salesdashboard.ashishoct34.workers.dev/";

/* GLOBAL DATA */
let fullData = {};
let flatList = [];

/* FETCH DATA */
async function loadData() {
    try {
        const res = await fetch(API_URL);
        const json = await res.json();

        fullData = json.data;
        flatList = Object.values(fullData).flat();

        renderAll();
    } catch (err) {
        console.error(err);
    }
}

/* SAFE DATE */
function safeDate(x) {
    if (!x) return null;
    const d = new Date(x);
    return isNaN(d) ? null : d;
}

/* DAYS BETWEEN */
function daysBetween(a, b = new Date()) {
    const d1 = safeDate(a);
    const d2 = safeDate(b);
    if (!d1 || !d2) return null;
    return Math.floor((d2 - d1) / (1000*60*60*24));
}

/* COUNT LOGIC */
function countAssigned(list) {
    return list.filter(x => x["assigned date"]).length;
}
function countAccepted(list) {
    return list.filter(x => x["reason if reverted"] === "").length;
}
function countReverted(list) {
    return list.filter(x => x["reason if reverted"]).length;
}
function countGSTransferred(list) {
    return list.filter(x => x["transferred to gs date"]).length;
}
function countCOE(list) {
    return list.filter(x => x["coe obtained date"]).length;
}

/* UPDATE SALES CARDS */
function buildOverviewCards() {
    const L = flatList;

    id("valAssigned").innerText = countAssigned(L);
    id("valAccepted").innerText = countAccepted(L);
    id("valReverted").innerText = countReverted(L);
    id("valGSTransferred").innerText = countGSTransferred(L);
    id("valCOE").innerText = countCOE(L);
}

/* FILTER DETAILS ON CARD CLICK */
function setupCardFilters() {
    id("cardAssigned").onclick = () => showFiltered("assigned date");
    id("cardAccepted").onclick = () => showFiltered("accepted");
    id("cardReverted").onclick = () => showFiltered("reverted");
    id("cardGS").onclick = () => showFiltered("transferred to gs date");
    id("cardCOE").onclick = () => showFiltered("coe obtained date");
}

function showFiltered(type) {
    openSection("sectionDetails");

    let rows = [];

    if (type === "accepted")
        rows = flatList.filter(x => x["reason if reverted"] === "");
    else if (type === "reverted")
        rows = flatList.filter(x => x["reason if reverted"]);
    else
        rows = flatList.filter(x => x[type]);

    renderDetails(rows);
}

/* GROUP BY MONTH */
function groupByMonth(list, field) {
    const map = {};
    list.forEach(x => {
        const d = safeDate(x[field]);
        if (!d) return;
        const key = `${d.getFullYear()}-${d.getMonth()+1}`;
        map[key] = (map[key]||0)+1;
    });
    return map;
}

/* BUILD BAR CHART */
function buildBarChart(canvas, labels, data, label) {
    new Chart(canvas, {
        type: "bar",
        data: {
            labels,
            datasets: [{
                label,
                data,
                backgroundColor: "#2563ebaa",
                borderColor: "#2563eb",
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            plugins:{legend:{labels:{color:"white"}}},
            scales:{
                x:{ticks:{color:"white"}},
                y:{ticks:{color:"white"}}
            }
        }
    });
}

/* BUILD TREND CHART FROM MAP */
function buildTrend(canvasId, map) {
    const labels = Object.keys(map);
    const values = Object.values(map);
    buildBarChart(id(canvasId), labels, values, "Count");
}

/* SALES TRENDS */
function buildSalesTrends() {
    buildTrend("chartAssigned", groupByMonth(flatList, "assigned date"));
    buildTrend("chartAccepted", groupByMonth(flatList.filter(x => x["reason if reverted"] === ""), "assigned date"));
    buildTrend("chartReverted", groupByMonth(flatList, "reason if reverted"));
    buildTrend("chartGSTransfers", groupByMonth(flatList, "transferred to gs date"));
}

/* SALES REP CHARTS */
function buildSalesRepCharts() {
    const reps = Object.keys(fullData);

    buildBarChart(
        id("chartSalesRepAssign"),
        reps,
        reps.map(r => countAssigned(fullData[r])),
        "Assigned"
    );

    buildBarChart(
        id("chartSalesRepGST"),
        reps,
        reps.map(r => countGSTransferred(fullData[r])),
        "Transferred to GS"
    );
}

/* GS OVERVIEW */
function buildGSOverview() {
    const GS = flatList.filter(x => x["transferred to gs date"]);

    id("gsTotal").innerText = GS.length;
    id("gsFullOfferPending").innerText = GS.filter(x => !x["full offer date"]).length;
    id("gsCOEPending").innerText = GS.filter(x => x["full offer date"] && !x["coe obtained date"]).length;
    id("gsVisaPending").innerText = GS.filter(x => x["coe obtained date"] && !x["visa lodged date"]).length;
}

/* GS ALERTS */
function buildGSAlerts() {
    const tbody = id("gsAlertsBody");
    tbody.innerHTML = "";

    const today = new Date();

    flatList.forEach(row=>{
        if (!row["transferred to gs date"]) return;

        const t = safeDate(row["transferred to gs date"]);
        const f = safeDate(row["full offer date"]);
        const c = safeDate(row["coe obtained date"]);
        const v = safeDate(row["visa lodged date"]);

        let stage="", stuck=0, status="";

        if (!f) { stage="Waiting Full Offer"; stuck=daysBetween(t); }
        else if (!c) { stage="Waiting COE"; stuck=daysBetween(f); }
        else if (!v) { stage="Waiting Visa Lodged"; stuck=daysBetween(c); }
        else { stage="Completed"; stuck=0; }

        let badgeClass =
            stuck === 0 ? "good" :
            stuck <= 5 ? "warn" :
            stuck <= 10 ? "bad" : "bad";

        let badgeText =
            stuck === 0 ? "On Track" :
            stuck <= 5 ? "Pending" :
            "Delayed";

        tbody.innerHTML += `
        <tr>
            <td>${row["client name"]}</td>
            <td>${row["gs lead"] || "-"}</td>
            <td>${stage}</td>
            <td>${stuck}</td>
            <td><span class="status-badge ${badgeClass}">${badgeText}</span></td>
        </tr>`;
    });
}

/* DETAILS */
function renderDetails(list) {
    const cols = [
        "client name","agentcis link","assignee","assigned date",
        "source","assigned office","sales rep","reason if reverted",
        "transferred to gs date","full offer date","coe obtained date",
        "visa lodged date","visa obtained date","gs lead"
    ];

    id("detailsHead").innerHTML =
        `<tr>${cols.map(x=>`<th>${x}</th>`).join("")}</tr>`;

    id("detailsBody").innerHTML =
        list.map(row =>
            `<tr>${cols.map(c=>`<td>${row[c]||""}</td>`).join("")}</tr>`
        ).join("");
}

/* MASTER RENDER */
function renderAll() {
    buildOverviewCards();
    setupCardFilters();
    buildSalesRepCharts();
    buildSalesTrends();
    buildGSOverview();
    buildGSAlerts();
    renderDetails(flatList);
}
/*-----------------------------------
    SIDEBAR SECTION SWITCHING
------------------------------------*/
function openSection(sectionId) {
    id("sectionSales").classList.remove("active");
    id("sectionGS").classList.remove("active");
    id("sectionDetails").classList.remove("active");

    id("btnSales").classList.remove("active");
    id("btnGS").classList.remove("active");
    id("btnDetails").classList.remove("active");

    id(sectionId).classList.add("active");

    if (sectionId === "sectionSales") id("btnSales").classList.add("active");
    if (sectionId === "sectionGS") id("btnGS").classList.add("active");
    if (sectionId === "sectionDetails") id("btnDetails").classList.add("active");
}

id("btnSales").onclick = () => {
    openSection("sectionSales");
    openSalesTab("salesOverview");
};

id("btnGS").onclick = () => {
    openSection("sectionGS");
    openGSTab("gsOverview");
};

id("btnDetails").onclick = () => {
    openSection("sectionDetails");
    renderDetails(flatList);
};

/*-----------------------------------
    SALES SUBTABS
------------------------------------*/
function openSalesTab(tab) {
    id("tabSalesOverview").classList.remove("active");
    id("tabSalesRep").classList.remove("active");

    id("salesOverview").classList.remove("active");
    id("salesRepPage").classList.remove("active");

    if (tab === "salesOverview") {
        id("tabSalesOverview").classList.add("active");
        id("salesOverview").classList.add("active");
    } else {
        id("tabSalesRep").classList.add("active");
        id("salesRepPage").classList.add("active");
    }
}

id("tabSalesOverview").onclick = () => openSalesTab("salesOverview");
id("tabSalesRep").onclick = () => openSalesTab("salesRep");

/*-----------------------------------
    GS SUBTABS
------------------------------------*/
function openGSTab(tab) {
    id("tabGSOverview").classList.remove("active");
    id("tabGSAlerts").classList.remove("active");

    id("gsOverview").classList.remove("active");
    id("gsAlerts").classList.remove("active");

    if (tab === "gsOverview") {
        id("tabGSOverview").classList.add("active");
        id("gsOverview").classList.add("active");
    } else {
        id("tabGSAlerts").classList.add("active");
        id("gsAlerts").classList.add("active");
    }
}

id("tabGSOverview").onclick = () => openGSTab("gsOverview");
id("tabGSAlerts").onclick = () => openGSTab("gsAlerts");

/*-----------------------------------
    DEFAULT LANDING PAGE
------------------------------------*/
openSection("sectionSales");
openSalesTab("salesOverview");

/*-----------------------------------
    RUN THE DASHBOARD
------------------------------------*/
loadData();

/*-----------------------------------
    HELPER
------------------------------------*/
function id(x) { return document.getElementById(x); }

</script>
</body>
</html>
