<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Sales & GS Dashboard | Premium</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-sidebar: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-primary: #38bdf8;
            /* Sky Blue */
            --accent-secondary: #818cf8;
            /* Indigo */
            --accent-success: #34d399;
            /* Emerald */
            --accent-warning: #fbbf24;
            /* Amber */
            --accent-danger: #f87171;
            /* Red */
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --glass-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            box-sizing: border-box;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) var(--bg-dark);
        }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            background-image:
                radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(129, 140, 248, 0.15) 0px, transparent 50%);
            font-family: 'Inter', sans-serif;
            color: var(--text-primary);
            overflow: hidden;
            /* App-like feel */
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-dark);
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-primary);
        }

        /* LAYOUT */
        .app-container {
            display: flex;
            height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: var(--glass-border);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 10;
        }

        .brand {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
            letter-spacing: -0.5px;
        }

        .brand i {
            color: var(--accent-primary);
        }

        .nav-menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 12px;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(56, 189, 248, 0.15), transparent);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* HEADER */
        .top-bar {
            height: 70px;
            padding: 0 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: var(--glass-border);
            backdrop-filter: blur(10px);
            background: rgba(15, 23, 42, 0.8);
            z-index: 9;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
        }

        .live-badge {
            padding: 6px 12px;
            background: rgba(52, 211, 153, 0.15);
            border: 1px solid rgba(52, 211, 153, 0.3);
            color: var(--accent-success);
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--accent-success);
            border-radius: 50%;
            box-shadow: 0 0 8px var(--accent-success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* SCROLLABLE AREA */
        .content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
        }

        /* SECTIONS */
        .section {
            display: none;
            animation: fadeIn 0.4s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* TABS */
        .tabs-container {
            margin-bottom: 25px;
            display: flex;
            gap: 10px;
            background: rgba(30, 41, 59, 0.5);
            padding: 5px;
            border-radius: 12px;
            width: fit-content;
            border: var(--glass-border);
        }

        .tab-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            background: var(--bg-sidebar);
            color: var(--accent-primary);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        /* CARDS GRID */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: rgba(56, 189, 248, 0.3);
            box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.3);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: var(--transition);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-title {
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -1px;
        }

        .stat-icon {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            opacity: 0.1;
            color: var(--text-primary);
        }

        /* CHARTS GRID */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-box {
            background: var(--bg-card);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            height: 350px;
            position: relative;
        }

        .chart-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* TABLES */
        .table-container {
            background: var(--bg-card);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .search-box {
            position: relative;
            width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: inherit;
            outline: none;
        }

        .search-box input:focus {
            border-color: var(--accent-primary);
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .data-table-wrapper {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        th {
            text-align: left;
            padding: 15px;
            color: var(--text-secondary);
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
        }

        th:hover {
            color: var(--text-primary);
        }

        th i {
            margin-left: 5px;
            font-size: 10px;
            opacity: 0.5;
        }

        td {
            padding: 14px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* STATUS BADGES */
        .status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-alert {
            background: rgba(248, 113, 113, 0.2);
            color: var(--accent-danger);
        }

        .status-warn {
            background: rgba(251, 191, 36, 0.2);
            color: var(--accent-warning);
        }

        .status-ok {
            background: rgba(52, 211, 153, 0.2);
            color: var(--accent-success);
        }

        /* LOADING */
        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            transition: opacity 0.5s;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid var(--text-secondary);
            border-bottom-color: var(--accent-primary);
            border-radius: 50%;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- LOADING -->
    <div id="loading-overlay">
        <div class="loader"></div>
    </div>

    <div class="app-container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="brand">
                <i class="fa-solid fa-chart-pie"></i>
                <span>NexusDash</span>
            </div>
            <div class="nav-menu">
                <div class="nav-item active" onclick="navTo('sectionSales', this)">
                    <i class="fa-solid fa-briefcase"></i> Sales
                </div>
                <div class="nav-item" onclick="navTo('sectionGS', this)">
                    <i class="fa-solid fa-rocket"></i> GS Performance
                </div>
                <div class="nav-item" onclick="navTo('sectionDetails', this)">
                    <i class="fa-solid fa-list"></i> Details
                </div>
            </div>
        </div>

        <!-- MAIN -->
        <div class="main-content">
            <!-- TOP BAR -->
            <div class="top-bar">
                <div class="page-title" id="pageTitle">Sales Overview</div>
                <div class="live-badge">
                    <div class="live-dot"></div> LIVE DATA
                </div>
            </div>

            <!-- CONTENT AREA -->
            <div class="content-scroll">

                <!-- ============================= -->
                <!-- SALES SECTION -->
                <!-- ============================= -->
                <div id="sectionSales" class="section active">
                    <div class="tabs-container">
                        <button class="tab-btn active" onclick="switchSubTab('salesOverview', this)">Overview</button>
                        <button class="tab-btn" onclick="switchSubTab('salesRepPage', this)">Sales Rep
                            Performance</button>
                    </div>

                    <!-- Sales Overview -->
                    <div id="salesOverview" class="sub-section active" style="display:block;">
                        <div class="cards-grid">
                            <div class="stat-card" onclick="filterDetails('assigned')">
                                <i class="fa-solid fa-inbox stat-icon"></i>
                                <div class="stat-title">Assigned</div>
                                <div class="stat-value" id="valAssigned">0</div>
                            </div>
                            <div class="stat-card" onclick="filterDetails('accepted')">
                                <i class="fa-solid fa-check-circle stat-icon"></i>
                                <div class="stat-title">Accepted</div>
                                <div class="stat-value" id="valAccepted">0</div>
                            </div>
                            <div class="stat-card" onclick="filterDetails('reverted')">
                                <i class="fa-solid fa-undo stat-icon"></i>
                                <div class="stat-title">Reverted</div>
                                <div class="stat-value" id="valReverted">0</div>
                            </div>
                            <div class="stat-card" onclick="filterDetails('gs')">
                                <i class="fa-solid fa-paper-plane stat-icon"></i>
                                <div class="stat-title">Transferred to GS</div>
                                <div class="stat-value" id="valGS">0</div>
                            </div>
                            <div class="stat-card" onclick="filterDetails('coe')">
                                <i class="fa-solid fa-certificate stat-icon"></i>
                                <div class="stat-title">COE Obtained</div>
                                <div class="stat-value" id="valCOE">0</div>
                            </div>
                        </div>

                        <div class="charts-grid">
                            <div class="chart-box">
                                <div class="chart-header">
                                    <div class="chart-title">Assigned Trend</div>
                                </div>
                                <canvas id="chartAssignedTrend"></canvas>
                            </div>
                            <div class="chart-box">
                                <div class="chart-header">
                                    <div class="chart-title">Accepted Trend</div>
                                </div>
                                <canvas id="chartAcceptedTrend"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Sales Rep Page -->
                    <div id="salesRepPage" class="sub-section" style="display:none;">
                        <div class="tabs-container" style="margin-top:0;">
                            <button class="tab-btn active" onclick="switchRep('Sweta', this)">Sweta</button>
                            <button class="tab-btn" onclick="switchRep('Anusha', this)">Anusha</button>
                            <button class="tab-btn" onclick="switchRep('Kumkum', this)">Kumkum</button>
                        </div>

                        <div id="repContent">
                            <!-- Dynamic Rep Content Injected Here -->
                            <div class="cards-grid">
                                <div class="stat-card" onclick="filterRepDetails('active')">
                                    <div class="stat-title">Active Clients</div>
                                    <div class="stat-value" id="repActive">0</div>
                                </div>
                                <div class="stat-card" style="cursor: default;">
                                    <div class="stat-title">Avg Days to Transfer</div>
                                    <div class="stat-value" id="repAvgDays">0</div>
                                </div>
                                <div class="stat-card" onclick="filterRepDetails('gs')">
                                    <div class="stat-title">GS Conversion</div>
                                    <div class="stat-value" id="repConvGS">0%</div>
                                </div>
                                <div class="stat-card" onclick="filterRepDetails('coe')">
                                    <div class="stat-title">COE Conversion</div>
                                    <div class="stat-value" id="repConvCOE">0%</div>
                                </div>
                                <div class="stat-card" onclick="filterRepDetails('visa')">
                                    <div class="stat-title">Visa Conversion</div>
                                    <div class="stat-value" id="repConvVisa">0%</div>
                                </div>
                            </div>

                            <div class="charts-grid">
                                <div class="chart-box">
                                    <div class="chart-title">Monthly Assigned</div>
                                    <canvas id="repChartAssigned"></canvas>
                                </div>
                                <div class="chart-box">
                                    <div class="chart-title">Monthly Transferred</div>
                                    <canvas id="repChartGS"></canvas>
                                </div>
                                <div class="chart-box">
                                    <div class="chart-title">Monthly Accepted</div>
                                    <canvas id="repChartAccepted"></canvas>
                                </div>
                            </div>

                            <div class="charts-grid">
                                <div class="chart-box">
                                    <div class="chart-title">Top Sources</div>
                                    <canvas id="repChartSources"></canvas>
                                </div>
                                <div class="chart-box">
                                    <div class="chart-title">Conversion Funnel</div>
                                    <canvas id="repChartFunnel"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================= -->
                <!-- GS SECTION -->
                <!-- ============================= -->
                <div id="sectionGS" class="section">
                    <div class="tabs-container">
                        <button class="tab-btn active" onclick="switchGSTab('gsOverview', this)">Overview</button>
                        <button class="tab-btn" onclick="switchGSTab('gsAlerts', this)">Alerts</button>
                    </div>

                    <div id="gsOverview" class="sub-section active" style="display:block;">
                        <div class="cards-grid">
                            <div class="stat-card" onclick="filterGSDetails('total')">
                                <div class="stat-title">Total GS Cases</div>
                                <div class="stat-value" id="gsTotal">0</div>
                            </div>
                            <div class="stat-card" onclick="filterGSDetails('offer')">
                                <div class="stat-title">Pending Full Offer</div>
                                <div class="stat-value" id="gsPendingOffer">0</div>
                            </div>
                            <div class="stat-card" onclick="filterGSDetails('coe')">
                                <div class="stat-title">Pending COE</div>
                                <div class="stat-value" id="gsPendingCOE">0</div>
                            </div>
                            <div class="stat-card" onclick="filterGSDetails('visa')">
                                <div class="stat-title">Pending Visa</div>
                                <div class="stat-value" id="gsPendingVisa">0</div>
                            </div>
                        </div>

                        <div class="charts-grid">
                            <div class="chart-box">
                                <div class="chart-title">Transfers Trend</div><canvas id="gsTransferTrend"></canvas>
                            </div>
                            <div class="chart-box">
                                <div class="chart-title">Avg Days to Full Offer</div><canvas id="avgOfferDays"></canvas>
                            </div>
                            <div class="chart-box">
                                <div class="chart-title">Avg Days to COE</div><canvas id="avgCOEDays"></canvas>
                            </div>
                            <div class="chart-box">
                                <div class="chart-title">Avg Days to Visa Lodged</div><canvas id="avgVisaDays"></canvas>
                            </div>
                        </div>
                    </div>

                    <div id="gsAlerts" class="sub-section" style="display:none;">
                        <div class="table-container">
                            <div class="table-controls">
                                <div class="search-box">
                                    <i class="fa-solid fa-search"></i>
                                    <input type="text" id="alertSearch" placeholder="Search alerts..."
                                        onkeyup="searchTable('gsAlertsTable', this.value)">
                                </div>
                            </div>
                            <div class="data-table-wrapper">
                                <table id="gsAlertsTable">
                                    <thead>
                                        <tr>
                                            <th onclick="sortTable('gsAlertsTable', 0)">Client <i
                                                    class="fa-solid fa-sort"></i></th>
                                            <th onclick="sortTable('gsAlertsTable', 1)">Stage <i
                                                    class="fa-solid fa-sort"></i></th>
                                            <th onclick="sortTable('gsAlertsTable', 2)">Days Stuck <i
                                                    class="fa-solid fa-sort"></i></th>
                                            <th onclick="sortTable('gsAlertsTable', 3)">GS Lead <i
                                                    class="fa-solid fa-sort"></i></th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ============================= -->
                <!-- DETAILS SECTION -->
                <!-- ============================= -->
                <div id="sectionDetails" class="section">
                    <div class="table-container">
                        <div class="table-controls">
                            <div class="search-box">
                                <i class="fa-solid fa-search"></i>
                                <input type="text" id="detailsSearch" placeholder="Search client, rep, status..."
                                    onkeyup="searchTable('detailsTable', this.value)">
                            </div>
                            <button onclick="resetDetails()"
                                style="margin-left:auto; padding:8px 16px; background:rgba(255,255,255,0.1); border:none; border-radius:8px; color:var(--text-secondary); cursor:pointer;">
                                <i class="fa-solid fa-rotate-left"></i> Reset
                            </button>
                        </div>
                        <div class="data-table-wrapper">
                            <table id="detailsTable">
                                <thead>
                                    <tr>
                                        <th onclick="sortTable('detailsTable', 0)">Client <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th>Link</th>
                                        <th onclick="sortTable('detailsTable', 2)">Assignee <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 3)">Assigned <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 4)">Source <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 5)">Office <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 6)">Rep <i class="fa-solid fa-sort"></i>
                                        </th>
                                        <th>Revert Reason</th>
                                        <th onclick="sortTable('detailsTable', 8)">GS Date <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 9)">Offer Date <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 10)">COE Date <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 11)">Visa Lodged <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 12)">Visa Grant <i
                                                class="fa-solid fa-sort"></i></th>
                                        <th onclick="sortTable('detailsTable', 13)">GS Lead <i
                                                class="fa-solid fa-sort"></i></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        /* ============================================
           CONFIG & UTILS
        ============================================ */
        const API_URL = "https://salesdashboard.ashishoct34.workers.dev/";
        let flatList = [];
        let currentRep = "Sweta";

        // Chart.js Global Defaults
        Chart.defaults.color = '#94a3b8';
        Chart.defaults.borderColor = 'rgba(255,255,255,0.05)';
        Chart.defaults.font.family = "'Inter', sans-serif";

        function id(x) { return document.getElementById(x); }

        function parseDate(v) {
            if (!v || !v.includes("-")) return null;
            const p = v.split("-");
            if (p.length < 3) return null;
            return new Date(+p[0], +p[1] - 1, +p[2]);
        }

        function diffDays(d1, d2) {
            if (!d1 || !d2) return 0;
            return Math.floor((d1 - d2) / (1000 * 3600 * 24));
        }

        function pct(a, b) {
            if (!b) return "0%";
            return ((a / b) * 100).toFixed(1) + "%";
        }

        /* ============================================
           NAVIGATION
        ============================================ */
        function navTo(secId, el) {
            document.querySelectorAll('.nav-item').forEach(x => x.classList.remove('active'));
            if (el) el.classList.add('active');

            document.querySelectorAll('.section').forEach(x => x.classList.remove('active'));
            id(secId).classList.add('active');

            const titles = {
                'sectionSales': 'Sales Overview',
                'sectionGS': 'GS Performance',
                'sectionDetails': 'Detailed Records'
            };
            id('pageTitle').textContent = titles[secId];
        }

        function switchSubTab(tabId, el) {
            el.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            const parent = el.closest('.section');
            parent.querySelectorAll('.sub-section').forEach(d => d.style.display = 'none');
            id(tabId).style.display = 'block';
        }

        function switchGSTab(tabId, el) {
            switchSubTab(tabId, el);
        }

        /* ============================================
           DATA LOADING
        ============================================ */
        async function loadData() {
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                const d = json.data;
                flatList = [...(d.Sweta || []), ...(d.Anusha || []), ...(d.Kumkum || [])];

                computeSalesOverview();
                computeRepData(currentRep);
                computeGSOverview();
                computeGSAlerts();
                renderDetails(flatList);

                id('loading-overlay').style.opacity = '0';
                setTimeout(() => id('loading-overlay').remove(), 500);

            } catch (e) {
                console.error("Error loading data", e);
                alert("Failed to load dashboard data.");
            }
        }

        /* ============================================
           SALES OVERVIEW
        ============================================ */
        function computeSalesOverview() {
            const total = flatList.length;
            const reverted = flatList.filter(x => x["reason if reverted"]).length;
            const accepted = total - reverted;
            const gs = flatList.filter(x => x["transferred to gs date"]).length;
            const coe = flatList.filter(x => x["coe obtained date"]).length;

            animateValue("valAssigned", total);
            animateValue("valAccepted", accepted);
            animateValue("valReverted", reverted);
            animateValue("valGS", gs);
            animateValue("valCOE", coe);

            createChart("chartAssignedTrend", "bar", groupMonthly(flatList, "assigned date"), "#38bdf8", (label) => filterByMonth(label, 'assigned'));
            createChart("chartAcceptedTrend", "bar", groupMonthly(flatList.filter(x => !x["reason if reverted"]), "assigned date"), "#34d399", (label) => filterByMonth(label, 'accepted'));
        }

        /* ============================================
           SALES REP LOGIC
        ============================================ */
        function switchRep(repName, el) {
            el.parentElement.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            el.classList.add('active');
            currentRep = repName;
            computeRepData(repName);
        }

        function computeRepData(rep) {
            const list = flatList.filter(x => x.assignee?.toLowerCase().includes(rep.toLowerCase()));

            const active = list.filter(x => !x["reason if reverted"] && !x["transferred to gs date"]).length;
            animateValue("repActive", active);

            const transfers = list.filter(x => x["transferred to gs date"]);
            let totalDays = 0;
            transfers.forEach(x => {
                const a = parseDate(x["assigned date"]);
                const t = parseDate(x["transferred to gs date"]);
                if (a && t) totalDays += diffDays(t, a);
            });
            const avg = transfers.length ? (totalDays / transfers.length).toFixed(1) : 0;
            id("repAvgDays").textContent = avg;

            const assigned = list.length;
            const gsCnt = list.filter(x => x["transferred to gs date"]).length;
            const coeCnt = list.filter(x => x["coe obtained date"]).length;
            const visaCnt = list.filter(x => x["visa lodged date"]).length;

            id("repConvGS").textContent = pct(gsCnt, assigned);
            id("repConvCOE").textContent = pct(coeCnt, assigned);
            id("repConvVisa").textContent = pct(visaCnt, assigned);

            createChart("repChartAssigned", "line", groupMonthly(list, "assigned date"), "#818cf8", (l) => filterRepByMonth(l, 'assigned'));
            createChart("repChartGS", "line", groupMonthly(list, "transferred to gs date"), "#38bdf8", (l) => filterRepByMonth(l, 'gs'));
            createChart("repChartAccepted", "line", groupMonthly(list.filter(x => !x["reason if reverted"]), "assigned date"), "#34d399", (l) => filterRepByMonth(l, 'accepted'));

            createDonut("repChartSources", groupSources(list), (l) => filterRepBySource(l));
            createFunnel("repChartFunnel", [assigned, gsCnt, coeCnt, visaCnt], (idx) => filterRepByStage(idx));
        }

        /* ============================================
           GS OVERVIEW
        ============================================ */
        function computeGSOverview() {
            const gsList = flatList.filter(x => x["transferred to gs date"]);

            animateValue("gsTotal", gsList.length);
            animateValue("gsPendingOffer", gsList.filter(x => !x["full offer date"]).length);
            animateValue("gsPendingCOE", gsList.filter(x => x["full offer date"] && !x["coe obtained date"]).length);
            animateValue("gsPendingVisa", gsList.filter(x => x["coe obtained date"] && !x["visa lodged date"]).length);

            createChart("gsTransferTrend", "bar", groupMonthly(gsList, "transferred to gs date"), "#a78bfa", (l) => filterGSByMonth(l));
            createAvgChart("avgOfferDays", gsList, "full offer date", "transferred to gs date", "#fbbf24");
            createAvgChart("avgCOEDays", gsList, "coe obtained date", "full offer date", "#f472b6");
            createAvgChart("avgVisaDays", gsList, "visa lodged date", "coe obtained date", "#34d399");
        }

        /* ============================================
           GS ALERTS
        ============================================ */
        function computeGSAlerts() {
            const body = id("gsAlertsTable").querySelector("tbody");
            body.innerHTML = "";

            flatList.forEach(x => {
                if (!x["transferred to gs date"] || x["visa lodged date"]) return;

                let stage = "", refDate = null;
                const tgs = parseDate(x["transferred to gs date"]);
                const full = parseDate(x["full offer date"]);
                const coe = parseDate(x["coe obtained date"]);

                if (tgs && !full) { stage = "Waiting Full Offer"; refDate = tgs; }
                else if (full && !coe) { stage = "Waiting COE"; refDate = full; }
                else if (coe && !x["visa lodged date"]) { stage = "Waiting Visa Lodged"; refDate = coe; }
                else return;

                const days = diffDays(new Date(), refDate);
                let statusClass = days >= 15 ? "status-alert" : (days >= 5 ? "status-warn" : "status-ok");
                let statusText = days >= 15 ? "Critical" : (days >= 5 ? "Warning" : "Normal");

                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${x["client name"] || ""}</td>
            <td>${stage}</td>
            <td>${days} days</td>
            <td>${x["gs lead"] || ""}</td>
            <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        `;
                body.appendChild(tr);
            });
        }

        /* ============================================
           DETAILS TABLE
        ============================================ */
        function renderDetails(list) {
            const body = id("detailsTable").querySelector("tbody");
            body.innerHTML = "";
            list.forEach(x => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
            <td>${x["client name"] || ""}</td>
            <td><a href="${x["agentcis link"]}" target="_blank" style="color:var(--accent-primary)">Open</a></td>
            <td>${x["assignee"] || ""}</td>
            <td>${x["assigned date"] || ""}</td>
            <td>${x["source"] || ""}</td>
            <td>${x["assigned office"] || ""}</td>
            <td>${x["sales rep"] || ""}</td>
            <td>${x["reason if reverted"] || ""}</td>
            <td>${x["transferred to gs date"] || ""}</td>
            <td>${x["full offer date"] || ""}</td>
            <td>${x["coe obtained date"] || ""}</td>
            <td>${x["visa lodged date"] || ""}</td>
            <td>${x["visa obtained date"] || ""}</td>
            <td>${x["gs lead"] || ""}</td>
        `;
                body.appendChild(tr);
            });
        }

        function resetDetails() {
            renderDetails(flatList);
            // Optionally clear search
            id('detailsSearch').value = '';
            searchTable('detailsTable', '');
        }

        /* ============================================
           INTERACTIONS & FILTERING
        ============================================ */
        function filterDetails(type) {
            navTo('sectionDetails', document.querySelectorAll('.nav-item')[2]);
            let filtered = [];
            if (type === 'assigned') filtered = flatList;
            if (type === 'accepted') filtered = flatList.filter(x => !x["reason if reverted"]);
            if (type === 'reverted') filtered = flatList.filter(x => x["reason if reverted"]);
            if (type === 'gs') filtered = flatList.filter(x => x["transferred to gs date"]);
            if (type === 'coe') filtered = flatList.filter(x => x["coe obtained date"]);
            renderDetails(filtered);
        }

        function filterRepDetails(type) {
            navTo('sectionDetails', document.querySelectorAll('.nav-item')[2]);
            let list = flatList.filter(x => x.assignee?.toLowerCase().includes(currentRep.toLowerCase()));
            let filtered = [];

            if (type === 'active') filtered = list.filter(x => !x["reason if reverted"] && !x["transferred to gs date"]);
            if (type === 'gs') filtered = list.filter(x => x["transferred to gs date"]);
            if (type === 'coe') filtered = list.filter(x => x["coe obtained date"]);
            if (type === 'visa') filtered = list.filter(x => x["visa lodged date"]);

            renderDetails(filtered);
        }

        function filterGSDetails(type) {
            navTo('sectionDetails', document.querySelectorAll('.nav-item')[2]);
            let list = flatList.filter(x => x["transferred to gs date"]);
            let filtered = [];

            if (type === 'total') filtered = list;
            if (type === 'offer') filtered = list.filter(x => !x["full offer date"]);
            if (type === 'coe') filtered = list.filter(x => x["full offer date"] && !x["coe obtained date"]);
            if (type === 'visa') filtered = list.filter(x => x["coe obtained date"] && !x["visa lodged date"]);

            renderDetails(filtered);
        }

        // Chart Filters
        function filterByMonth(label, type) {
            navTo('sectionDetails', document.querySelectorAll('.nav-item')[2]);
            // label format "Nov 24"
            let filtered = flatList.filter(x => {
                let d = parseDate(x["assigned date"]);
                if (!d) return false;
                let k = d.toLocaleString('default', { month: 'short' }) + " " + d.getFullYear().toString().substr(2);
                if (k !== label) return false;

                if (type === 'accepted') return !x["reason if reverted"];
                return true;
            });
            renderDetails(filtered);
        }

        function filterRepByMonth(label, type) {
            navTo('sectionDetails', document.querySelectorAll('.nav-item')[2]);
            let list = flatList.filter(x => x.assignee?.toLowerCase().includes(currentRep.toLowerCase()));

            let filtered = list.filter(x => {
                let field = (type === 'gs') ? "transferred to gs date" : "assigned date";
                let d = parseDate(x[field]);
                if (!d) return false;
                let k = d.toLocaleString('default', { month: 'short' }) + " " + d.getFullYear().toString().substr(2);
                if (k !== label) return false;

                if (type === 'accepted') return !x["reason if reverted"];
                return true;
            });
            renderDetails(filtered);
        }

        function filterRepBySource(source) {
            navTo('sectionDetails', document.querySelectorAll('.nav-item')[2]);
            let list = flatList.filter(x => x.assignee?.toLowerCase().includes(currentRep.toLowerCase()));
            let filtered = list.filter(x => (x["source"] || "Unknown").trim() === source);
            renderDetails(filtered);
        }

        function filterRepByStage(index) {
            navTo('sectionDetails', document.querySelectorAll('.nav-item')[2]);
            let list = flatList.filter(x => x.assignee?.toLowerCase().includes(currentRep.toLowerCase()));
            let filtered = [];
            // 0: Assigned, 1: GS, 2: COE, 3: Visa
            if (index === 0) filtered = list;
            if (index === 1) filtered = list.filter(x => x["transferred to gs date"]);
            if (index === 2) filtered = list.filter(x => x["coe obtained date"]);
            if (index === 3) filtered = list.filter(x => x["visa lodged date"]);
            renderDetails(filtered);
        }

        function filterGSByMonth(label) {
            navTo('sectionDetails', document.querySelectorAll('.nav-item')[2]);
            let list = flatList.filter(x => x["transferred to gs date"]);
            let filtered = list.filter(x => {
                let d = parseDate(x["transferred to gs date"]);
                if (!d) return false;
                let k = d.toLocaleString('default', { month: 'short' }) + " " + d.getFullYear().toString().substr(2);
                return k === label;
            });
            renderDetails(filtered);
        }

        function searchTable(tableId, query) {
            const trs = id(tableId).querySelectorAll("tbody tr");
            query = query.toLowerCase();
            trs.forEach(tr => {
                const text = tr.textContent.toLowerCase();
                tr.style.display = text.includes(query) ? "" : "none";
            });
        }

        function sortTable(tableId, colIdx) {
            const table = id(tableId);
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr"));
            const isAsc = table.getAttribute("data-sort-asc") === "true";

            rows.sort((a, b) => {
                const tA = a.children[colIdx].textContent.trim();
                const tB = b.children[colIdx].textContent.trim();
                return isAsc ? tA.localeCompare(tB) : tB.localeCompare(tA);
            });

            table.setAttribute("data-sort-asc", !isAsc);
            tbody.append(...rows);
        }

        /* ============================================
           CHART HELPERS
        ============================================ */
        let charts = {};

        function createChart(canvasId, type, dataMap, color, onClickFn) {
            const ctx = id(canvasId);
            if (!ctx) return;
            if (charts[canvasId]) charts[canvasId].destroy();

            charts[canvasId] = new Chart(ctx, {
                type: type,
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        label: "Count",
                        data: Object.values(dataMap),
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 2,
                        tension: 0.4,
                        pointBackgroundColor: varCSS('--bg-dark'),
                        fill: type === 'line'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { grid: { display: false } }
                    },
                    onClick: (e, elements) => {
                        if (elements.length > 0 && onClickFn) {
                            const idx = elements[0].index;
                            const label = Object.keys(dataMap)[idx];
                            onClickFn(label);
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        function createDonut(canvasId, dataMap, onClickFn) {
            const ctx = id(canvasId);
            if (!ctx) return;
            if (charts[canvasId]) charts[canvasId].destroy();

            const colors = ['#38bdf8', '#818cf8', '#34d399', '#fbbf24', '#f87171'];

            charts[canvasId] = new Chart(ctx, {
                type: "doughnut",
                data: {
                    labels: Object.keys(dataMap),
                    datasets: [{
                        data: Object.values(dataMap),
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: { legend: { position: 'right', labels: { color: '#94a3b8' } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0 && onClickFn) {
                            const idx = elements[0].index;
                            const label = Object.keys(dataMap)[idx];
                            onClickFn(label);
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        function createFunnel(canvasId, arr, onClickFn) {
            const ctx = id(canvasId);
            if (!ctx) return;
            if (charts[canvasId]) charts[canvasId].destroy();

            charts[canvasId] = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Assigned", "GS", "COE", "Visa"],
                    datasets: [{
                        data: arr,
                        backgroundColor: ['#818cf8', '#38bdf8', '#34d399', '#fbbf24'],
                        borderRadius: 6
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { x: { grid: { color: 'rgba(255,255,255,0.05)' } }, y: { grid: { display: false } } },
                    onClick: (e, elements) => {
                        if (elements.length > 0 && onClickFn) {
                            const idx = elements[0].index;
                            onClickFn(idx);
                        }
                    },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    }
                }
            });
        }

        function createAvgChart(canvasId, list, endField, startField, color) {
            const ctx = id(canvasId);
            if (!ctx) return;
            if (charts[canvasId]) charts[canvasId].destroy();

            let sum = 0, count = 0;
            list.forEach(x => {
                const s = parseDate(x[startField]);
                const e = parseDate(x[endField]);
                if (s && e) { sum += diffDays(e, s); count++; }
            });
            const avg = count ? (sum / count).toFixed(1) : 0;

            charts[canvasId] = new Chart(ctx, {
                type: "bar",
                data: {
                    labels: ["Avg Days"],
                    datasets: [{
                        data: [avg],
                        backgroundColor: color,
                        borderRadius: 8,
                        barThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { display: false } }
                }
            });
        }

        /* ============================================
           UTILS
        ============================================ */
        function groupMonthly(arr, field) {
            const map = {};
            arr.forEach(x => {
                const d = parseDate(x[field]);
                if (!d) return;
                const key = d.toLocaleString('default', { month: 'short' }) + " " + d.getFullYear().toString().substr(2);
                map[key] = (map[key] || 0) + 1;
            });
            return map;
        }

        function groupSources(arr) {
            const map = {};
            arr.forEach(x => {
                const s = (x["source"] || "Unknown").trim();
                map[s] = (map[s] || 0) + 1;
            });
            // Sort and take top 5
            const sorted = Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, 5);
            return Object.fromEntries(sorted);
        }

        function animateValue(id, end) {
            const obj = document.getElementById(id);
            if (!obj) return;
            let start = 0;
            const duration = 1000;
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                obj.innerHTML = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function varCSS(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        // Init
        loadData();

    </script>
</body>

</html>
