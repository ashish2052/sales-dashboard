<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sales & GS Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
    margin:0; background:#050c1b;
    font-family:'Poppins',sans-serif;
    color:#dce7ff;
    overflow-x:hidden;
}
.fade { animation:fadeIn .5s ease }
@keyframes fadeIn { from{opacity:0; transform:translateY(10px);} to{opacity:1;} }

/* SIDEBAR */
.sidebar {
    position:fixed; width:220px; height:100vh;
    background:#061022; padding-top:20px;
    box-shadow:4px 0 20px rgba(0,0,0,0.4);
}
.sidebar button {
    width:180px; margin:10px 20px; padding:14px;
    background:#0b1a38; border:none; border-radius:10px;
    color:#bcd2ff; text-align:left; cursor:pointer;
    transition:.25s; font-size:15px;
}
.sidebar button.active {
    background:#0b8c00; color:white;
    box-shadow:0 0 12px #00ff62cc;
}

/* MAIN */
.main { margin-left:240px; padding:25px; }

/* HEADER */
.header {
    font-size:30px; font-weight:600;
    color:#9fc4ff; margin-bottom:5px;
}
.liveTag {
    display:inline-block;
    background:#00c85333;
    color:#79ff90;
    padding:4px 12px;
    border-radius:6px;
    font-size:12px;
    border:1px solid #00ff62;
    margin-left:10px;
}

/* TABS */
.tabRow { margin-top:15px; }
.tabRow button{
    margin-right:8px; padding:8px 16px;
    background:#09162f; border:1px solid #1d3464;
    border-radius:8px; color:#a8c7ff;
    cursor:pointer; transition:.2s;
}
.tabRow button.active{
    background:#0b8c00; border-color:#0b8c00;
    color:white;
}

/* CARDS */
.cardRow { display:flex; gap:20px; margin-top:25px; }
.card {
    flex:1; background:#0a162f; border:1px solid #1d3464;
    border-radius:14px; padding:24px; text-align:center;
    cursor:pointer; transition:.25s;
}
.card:hover { transform:translateY(-4px); box-shadow:0 0 12px #0099ff88; }
.cardTitle { color:#b7cbff; font-size:15px; }
.cardValue { color:white; font-size:32px; font-weight:600; text-shadow:0 0 10px #004fff; }

/* DATE FILTER */
.filterRow { display:flex; gap:10px; margin-top:10px; }
.filterRow input{
    padding:8px 12px; background:#09162f;
    border:1px solid #1d3464; border-radius:8px;
    color:#dce7ff;
}
.filterRow button{
    padding:8px 14px; border:none; background:#0b8c00;
    color:white; border-radius:8px; cursor:pointer;
}

/* CHART GRID */
.chartGrid {
    margin-top:25px;
    display:grid; grid-template-columns:repeat(2,1fr);
    gap:25px;
}
.chartBox {
    background:#0a162f; border:1px solid #1d3464;
    border-radius:12px; padding:20px;
    height:320px;
}

/* TABLE */
.tableBox{
    margin-top:25px; background:#0a162f;
    border:1px solid #1d3464; border-radius:12px;
    padding:20px;
}
table { width:100%; border-collapse:collapse; }
th,td {
    padding:10px; border-bottom:1px solid #1d3464;
}
th { color:#8fb8ff; }

/* PAGES */
.page{ display:none; }
</style>
</head>

<body>
<div class="sidebar">
  <button id="btnSales" class="active">Sales</button>
  <button id="btnGS">GS Performance</button>
  <button id="btnDetails">Details</button>
</div>

<div class="main fade">

  <div class="header">
    Sales & GS Dashboard
    <span class="liveTag">✔ Live — Google Sheets</span>
  </div>

  <!-- SALES -->
  <div id="pageSales" class="page" style="display:block;">

    <div class="tabRow">
      <button id="tabSalesOverview" class="active">Sales Overview</button>
      <button id="tabSalesRep">Sales Rep</button>
    </div>

    <div class="filterRow">
      <span>Date:</span>
      <input type="date" id="dateFrom">
      <input type="date" id="dateTo">
      <button onclick="applyDateFilter()">Apply</button>
    </div>

    <!-- SALES OVERVIEW -->
    <div id="salesOverview">
      <div class="cardRow fade">
        <div class="card" id="cardAssigned"><div class="cardTitle">Assigned</div><div class="cardValue" id="valAssigned">0</div></div>
        <div class="card" id="cardAccepted"><div class="cardTitle">Accepted</div><div class="cardValue" id="valAccepted">0</div></div>
        <div class="card" id="cardReverted"><div class="cardTitle">Reverted</div><div class="cardValue" id="valReverted">0</div></div>
        <div class="card" id="cardGSTransfer"><div class="cardTitle">Transferred to GS</div><div class="cardValue" id="valGSTransfer">0</div></div>
        <div class="card" id="cardCOE"><div class="cardTitle">COE</div><div class="cardValue" id="valCOE">0</div></div>
      </div>

      <div class="chartGrid fade">
        <div class="chartBox"><h3>Assigned Trend</h3><canvas id="chartAssigned"></canvas></div>
        <div class="chartBox"><h3>Accepted Trend</h3><canvas id="chartAccepted"></canvas></div>
      </div>
    </div>

    <!-- SALES REP -->
    <div id="salesRepPage" style="display:none;">
      <div class="chartGrid fade">
        <div class="chartBox"><h3>Sales Rep Comparison</h3><canvas id="chartSalesRep"></canvas></div>
        <div class="chartBox"><h3>GS Transfers</h3><canvas id="chartRepGSTransfer"></canvas></div>
      </div>
    </div>

  </div>

  <!-- GS PERFORMANCE -->
  <div id="pageGS" class="page">
    <div class="tabRow">
      <button id="tabGSOverview" class="active">GS Overview</button>
      <button id="tabGSAlerts">Alerts</button>
    </div>

    <!-- GS OVERVIEW -->
    <div id="gsOverview">
      <div class="cardRow fade">
        <div class="card"><div class="cardTitle">Avg Days: Transfer → Offer</div><div class="cardValue" id="valOfferDays">0</div></div>
        <div class="card"><div class="cardTitle">Avg Days: Offer → COE</div><div class="cardValue" id="valCOEDays">0</div></div>
        <div class="card"><div class="cardTitle">Avg Days: COE → Visa</div><div class="cardValue" id="valVisaDays">0</div></div>
      </div>

      <div class="chartGrid fade">
        <div class="chartBox"><h3>Offer Trend</h3><canvas id="chartOffer"></canvas></div>
        <div class="chartBox"><h3>COE Trend</h3><canvas id="chartCOE"></canvas></div>
      </div>
    </div>

    <!-- ALERTS -->
    <div id="gsAlerts" style="display:none;">
      <div class="tableBox fade">
        <h2>⚠ Stuck Cases</h2>
        <table id="alertTable">
          <thead><tr>
            <th>Client</th><th>GS Lead</th><th>Transferred</th><th>Offer</th><th>COE</th><th>Visa</th><th>Status</th>
          </tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- DETAILS -->
  <div id="pageDetails" class="page">
    <div class="tableBox fade">
      <h2>Details</h2>
      <table id="detailsTable">
        <thead><tr>
          <th>Sales Rep</th><th>Assigned</th><th>Transferred</th><th>COE</th><th>GS Lead</th>
        </tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<script>
const API_URL = "https://salesdashboard.ashishoct34.workers.dev/";
let raw=[];

/* PAGE SWITCH */
id("btnSales").onclick=()=>show("sales");
id("btnGS").onclick=()=>show("gs");
id("btnDetails").onclick=()=>show("details");

function show(x){
  id("pageSales").style.display=x==="sales"?"block":"none";
  id("pageGS").style.display=x==="gs"?"block":"none";
  id("pageDetails").style.display=x==="details"?"block":"none";
}

/* SUB TABS */
id("tabSalesOverview").onclick=()=>swap("tabSalesOverview","tabSalesRep","salesOverview","salesRepPage");
id("tabSalesRep").onclick=()=>swap("tabSalesRep","tabSalesOverview","salesRepPage","salesOverview");

id("tabGSOverview").onclick=()=>swap("tabGSOverview","tabGSAlerts","gsOverview","gsAlerts");
id("tabGSAlerts").onclick=()=>swap("tabGSAlerts","tabGSOverview","gsAlerts","gsOverview");

function swap(a,b,x,y){
  id(a).classList.add("active");
  id(b).classList.remove("active");
  id(x).style.display="block";
  id(y).style.display="none";
}

/* LOAD DATA */
load();
async function load(){
  const r = await fetch(API_URL);
  const j = await r.json();
  raw = flatten(j.data);
  computeAll(raw);
}

/* FLATTEN DATA (Sweta, Anusha, Kumkum arrays → 1 array) */
function flatten(d){
  let arr=[];
  Object.keys(d).forEach(rep=>{
    d[rep].forEach(x=>arr.push(x));
  });
  return arr;
}

/* HELPERS */
function id(x){ return document.getElementById(x); }
function dd(x){
  if(!x) return null;
  let p=x.split("-");
  if(p.length!==3) return null;
  return new Date(`${p[0]}-${p[1]}-${p[2]}`);
}
function datediff(a,b){
  if(!a||!b) return null;
  return Math.round((b-a)/86400000);
}

/* DATE FILTER */
function applyDateFilter(){
  let f=id("dateFrom").value? new Date(id("dateFrom").value):null;
  let t=id("dateTo").value? new Date(id("dateTo").value):null;

  if(!f && !t){ computeAll(raw); return; }

  const filtered = raw.filter(r=>{
    let ad=dd(r["assigned date"]);
    if(!ad) return false;
    if(f && ad<f) return false;
    if(t && ad>t) return false;
    return true;
  });
  computeAll(filtered);
}

/* MASTER CALC */
function computeAll(data){
  computeSales(data);
  computeSalesRep(data);
  computeGS(data);
  computeAlerts(data);
  computeDetails(data);
}

/* SALES */
function computeSales(data){
  let assigned=0, reverted=0, gs=0, coe=0;
  const trend={};

  data.forEach(r=>{
    let ad=dd(r["assigned date"]);
    if(ad) assigned++;

    if(r["reason if reverted"] && r["reason if reverted"].trim()!=="") reverted++;

    if(r["transferred to gs date"]) gs++;
    if(r["coe obtained date"]) coe++;

    if(ad){
      let k=(ad.getMonth()+1)+"/"+ad.getFullYear();
      trend[k]=(trend[k]||0)+1;
    }
  });

  let accepted = assigned-reverted;

  id("valAssigned").textContent=assigned;
  id("valAccepted").textContent=accepted;
  id("valReverted").textContent=reverted;
  id("valGSTransfer").textContent=gs;
  id("valCOE").textContent=coe;

  draw("chartAssigned",trend,"Assigned");
  draw("chartAccepted",trend,"Accepted");
}

/* SALES REP */
function computeSalesRep(data){
  let reps={};

  data.forEach(r=>{
    let rep=r["sales rep"];
    if(!reps[rep]) reps[rep]={a:0,rev:0,gs:0};

    if(r["assigned date"]) reps[rep].a++;
    if(r["reason if reverted"]) reps[rep].rev++;
    if(r["transferred to gs date"]) reps[rep].gs++;
  });

  let labels=Object.keys(reps);
  draw("chartSalesRep", toObj(labels, labels.map(l=>reps[l].a)), "Assigned");
  draw("chartRepGSTransfer", toObj(labels, labels.map(l=>reps[l].gs)), "GS Transfers");
}

function toObj(l,v){
  let o={}; l.forEach((x,i)=>o[x]=v[i]); return o;
}

/* GS PERFORMANCE */
function computeGS(data){
  let offerArr=[],coeArr=[],visaArr=[];
  let offerTrend={}, coeTrend={};

  data.forEach(r=>{
    let t=dd(r["transferred to gs date"]);
    let off=dd(r["full offer date"]);
    let coe=dd(r["coe obtained date"]);
    let visa=dd(r["visa lodged date"]);

    let d1=datediff(t,off);
    if(d1!==null){ offerArr.push(d1); if(off){ let k=(off.getMonth()+1)+"/"+off.getFullYear(); offerTrend[k]=(offerTrend[k]||0)+1; }}

    let d2=datediff(off,coe);
    if(d2!==null){ coeArr.push(d2); if(coe){ let k=(coe.getMonth()+1)+"/"+coe.getFullYear(); coeTrend[k]=(coeTrend[k]||0)+1; }}

    let d3=datediff(coe,visa);
    if(d3!==null) visaArr.push(d3);
  });

  id("valOfferDays").textContent = avg(offerArr);
  id("valCOEDays").textContent = avg(coeArr);
  id("valVisaDays").textContent = avg(visaArr);

  draw("chartOffer",offerTrend,"Offers");
  draw("chartCOE",coeTrend,"COE");
}
function avg(a){ return a.length? Math.round(a.reduce((x,y)=>x+y)/a.length):0; }

/* ALERTS */
function computeAlerts(data){
  let tbody=document.querySelector("#alertTable tbody");
  tbody.innerHTML="";

  data.forEach(r=>{
    let t=dd(r["transferred to gs date"]);
    let off=dd(r["full offer date"]);
    let coe=dd(r["coe obtained date"]);
    let visa=dd(r["visa lodged date"]);
    let status="";

    if(t && !off && datediff(t,new Date())>10) status="Offer Delayed";
    if(off && !coe && datediff(off,new Date())>7) status="COE Delayed";
    if(coe && !visa && datediff(coe,new Date())>7) status="Visa Delayed";

    if(status!==""){
      tbody.innerHTML+=`
      <tr>
        <td>${r["client name"]}</td>
        <td>${r["gs lead"]}</td>
        <td>${r["transferred to gs date"]}</td>
        <td>${r["full offer date"]}</td>
        <td>${r["coe obtained date"]}</td>
        <td>${r["visa lodged date"]}</td>
        <td style="color:#ff6b6b">${status}</td>
      </tr>`;
    }
  });
}

/* DETAILS */
function computeDetails(data){
  let tbody=document.querySelector("#detailsTable tbody");
  tbody.innerHTML="";
  data.forEach(r=>{
    tbody.innerHTML+=`
    <tr>
      <td>${r["sales rep"]}</td>
      <td>${r["assigned date"]}</td>
      <td>${r["transferred to gs date"]}</td>
      <td>${r["coe obtained date"]}</td>
      <td>${r["gs lead"]}</td>
    </tr>`;
  });
}

/* CHART DRAW */
function draw(cid, obj, label){
  const ctx=document.getElementById(cid);
  if(!ctx) return;

  new Chart(ctx,{
    type:"bar",
    data:{
      labels:Object.keys(obj),
      datasets:[{
        label:label,
        data:Object.values(obj),
        backgroundColor:"#1a6bffbb",
        borderColor:"#5b8eff",
        borderWidth:2,
        borderRadius:8
      }]
    },
    options:{
      animation:{duration:800},
      responsive:true, maintainAspectRatio:false,
      scales:{ y:{beginAtZero:true} }
    }
  });
}
</script>

</body>
</html>
