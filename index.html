<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Sales & GS Neon Dashboard</title>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* ============= GLOBAL NEON THEME ============= */
body {
  margin: 0;
  font-family: "Poppins", sans-serif;
  background: #050c1b;
  color: #e8efff;
  overflow-x: hidden;
}
::-webkit-scrollbar {
  width: 6px;
}
::-webkit-scrollbar-thumb {
  background: #1a2b52;
  border-radius: 10px;
}

/* Sidebar */
.sidebar {
  width: 220px;
  height: 100vh;
  background: #071123;
  padding-top: 20px;
  position: fixed;
  top: 0;
  left: 0;
  box-shadow: 4px 0 15px rgba(0,0,0,0.4);
}
.sidebar button {
  width: 180px;
  margin: 10px 20px;
  padding: 14px;
  background: #0e1c38;
  border: none;
  border-radius: 10px;
  text-align: left;
  color: #bcd2ff;
  font-size: 15px;
  cursor: pointer;
  transition: 0.25s;
}
.sidebar button.active {
  background: #0c47ff;
  color: white;
  box-shadow: 0 0 15px #005eff;
}
.sidebar button:hover {
  background: #123165;
}

/* Main Content */
.main {
  margin-left: 240px;
  padding: 20px 30px;
}

/* Header */
.header {
  font-size: 28px;
  font-weight: 600;
  color: #9fbeff;
  text-shadow: 0 0 10px #006aff;
}
.liveTag {
  background: #00d2ff33;
  padding: 6px 14px;
  border-radius: 8px;
  margin-left: 10px;
  font-size: 12px;
  color: #86c8ff;
  border: 1px solid #008cff;
}

/* Tabs */
.tabRow {
  margin-top: 15px;
}
.tabRow button {
  margin-right: 8px;
  padding: 8px 16px;
  background: #09162f;
  border: 1px solid #1d3464;
  color: #a8c7ff;
  border-radius: 8px;
  cursor: pointer;
}
.tabRow button.active {
  background: #0c47ff;
  border-color: #0c47ff;
  color: white;
}

/* Cards */
.cardRow {
  display: flex;
  gap: 20px;
  margin-top: 25px;
}
.card {
  flex: 1;
  background: #09162f;
  padding: 25px;
  border-radius: 14px;
  text-align: center;
  border: 1px solid #1d3464;
  box-shadow: 0 0 10px #002f7a inset;
  cursor: pointer;
}
.cardTitle {
  font-size: 16px;
  color: #b7cbff;
}
.cardValue {
  font-size: 32px;
  font-weight: 600;
  margin-top: 5px;
  color: white;
  text-shadow: 0 0 10px #005eff;
}

/* Chart Grid (two per row) */
.chartGrid {
  margin-top: 30px;
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 25px;
}
.chartBox {
  background: #09162f;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #1d3464;
  box-shadow: inset 0 0 10px #002f7a;
}

/* Details Table */
.tableBox {
  margin-top: 25px;
  background: #09162f;
  padding: 20px;
  border-radius: 12px;
  border: 1px solid #1d3464;
}
table {
  width: 100%;
  border-collapse: collapse;
  color: #d2e2ff;
}
th, td {
  padding: 10px;
  border-bottom: 1px solid #1d3464;
}
th {
  color: #8fb8ff;
}

/* Hide all pages by default */
.page { display: none; }
</style>
</head>

<body>

<!-- ================= SIDEBAR ================= -->
<div class="sidebar">
  <button id="btnSales" class="active">Sales</button>
  <button id="btnGS">GS Performance</button>
  <button id="btnDetails">Details</button>
</div>

<!-- ================= MAIN AREA ================= -->
<div class="main">
  <div class="header">
    Sales & GS Neon Dashboard
    <span class="liveTag">✔ Live — Google Sheets</span>
  </div>

  <!-- SALES PAGES -->
  <div id="pageSales" class="page" style="display:block;">

      <!-- Sales Tabs -->
      <div class="tabRow">
        <button id="tabSalesOverview" class="active">Sales Overview</button>
        <button id="tabSalesRep">Sales Rep</button>
      </div>

      <!-- SALES OVERVIEW CONTENT -->
      <div id="salesOverview">

        <div class="cardRow">
          <div class="card" id="cardAssigned">
            <div class="cardTitle">Assigned</div>
            <div class="cardValue" id="valAssigned">0</div>
          </div>

          <div class="card" id="cardAccepted">
            <div class="cardTitle">Accepted</div>
            <div class="cardValue" id="valAccepted">0</div>
          </div>

          <div class="card" id="cardReverted">
            <div class="cardTitle">Reverted</div>
            <div class="cardValue" id="valReverted">0</div>
          </div>

          <div class="card" id="cardGSTransfer">
            <div class="cardTitle">Transferred to GS</div>
            <div class="cardValue" id="valGSTransfer">0</div>
          </div>

          <div class="card" id="cardCOE">
            <div class="cardTitle">COE</div>
            <div class="cardValue" id="valCOE">0</div>
          </div>
        </div>

        <!-- Charts -->
        <div class="chartGrid">
          <div class="chartBox">
            <h3>Assigned Trend</h3>
            <canvas id="chartAssigned"></canvas>
          </div>

          <div class="chartBox">
            <h3>Accepted Trend</h3>
            <canvas id="chartAccepted"></canvas>
          </div>
        </div>
      </div>

      <!-- SALES REP PAGE -->
      <div id="salesRepPage" style="display:none;">
        <div class="chartGrid">
          <div class="chartBox">
            <h3>Sales Rep Comparison</h3>
            <canvas id="chartSalesRep"></canvas>
          </div>
          <div class="chartBox">
            <h3>Transfers to GS by Rep</h3>
            <canvas id="chartRepGSTransfer"></canvas>
          </div>
        </div>
      </div>

  </div>

  <!-- ================= GS PERFORMANCE ================= -->
  <div id="pageGS" class="page">

    <div class="tabRow">
      <button id="tabGSOverview" class="active">GS Overview</button>
      <button id="tabGSAlerts">Alerts</button>
    </div>

    <!-- GS OVERVIEW -->
    <div id="gsOverview">

      <div class="cardRow">
        <div class="card"><div class="cardTitle">Avg Days: Transfer → Offer</div><div class="cardValue" id="valOfferDays">0</div></div>
        <div class="card"><div class="cardTitle">Avg Days: Offer → COE</div><div class="cardValue" id="valCOEDays">0</div></div>
        <div class="card"><div class="cardTitle">Avg Days: COE → Visa</div><div class="cardValue" id="valVisaDays">0</div></div>
      </div>

      <div class="chartGrid">
        <div class="chartBox"><h3>Offer Time Trend</h3><canvas id="chartOffer"></canvas></div>
        <div class="chartBox"><h3>COE Time Trend</h3><canvas id="chartCOE"></canvas></div>
      </div>

    </div>

    <!-- GS ALERTS -->
    <div id="gsAlerts" style="display:none;">
      <div class="tableBox">
        <h2>⚠️ Stuck Cases</h2>
        <table id="alertTable">
          <thead>
            <tr>
              <th>Client</th>
              <th>GS Lead</th>
              <th>Transferred</th>
              <th>Full Offer</th>
              <th>COE</th>
              <th>Visa Lodged</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- ================= DETAILS PAGE ================= -->
  <div id="pageDetails" class="page">
    <div class="tableBox">
      <h2>Details</h2>
      <table id="detailsTable">
        <thead>
          <tr>
            <th>Sales Rep</th>
            <th>Assigned Date</th>
            <th>Transferred</th>
            <th>COE</th>
            <th>GS Lead</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<!-- ================= START OF JAVASCRIPT ================= -->
<script>
// API URL
const API_URL = "https://salesdashboard.ashishoct34.workers.dev/";

// DOM pages
const pageSales = document.getElementById("pageSales");
const pageGS = document.getElementById("pageGS");
const pageDetails = document.getElementById("pageDetails");

// Sidebar buttons
document.getElementById("btnSales").onclick = () => showPage("sales");
document.getElementById("btnGS").onclick = () => showPage("gs");
document.getElementById("btnDetails").onclick = () => showPage("details");

function showPage(p) {
    pageSales.style.display = p === "sales" ? "block" : "none";
    pageGS.style.display = p === "gs" ? "block" : "none";
    pageDetails.style.display = p === "details" ? "block" : "none";
}
/* ============================
   FETCH DATA FROM API
============================ */
async function loadData() {
    try {
        const response = await fetch(API_URL);
        const json = await response.json();
        if (!json.success) throw new Error("API error");

        const rows = json.data || json.rows || json.attendees || [];

        window.rawData = rows;   // Global stash for filtering & details

        computeSalesOverview(rows);
        computeSalesRep(rows);
        computeGS(rows);
        computeAlerts(rows);
        populateDetails(rows);

    } catch (e) {
        console.error("LOAD ERROR", e);
    }
}

loadData();

/* =======================================================
    HELPERS
======================================================= */

function parseDate(d) {
    if (!d || d.trim() === "" || d === "Invalid Date") return null;
    const parts = d.includes("/") ? d.split("/") : d.split("-");
    if (parts.length < 3) return null;
    let [dd, mm, yyyy] = parts;
    if (yyyy.length === 2) yyyy = "20" + yyyy;
    return new Date(`${yyyy}-${mm}-${dd}`);
}

function daysBetween(a, b) {
    if (!a || !b) return null;
    return Math.round((b - a) / (1000 * 3600 * 24));
}

/* =======================================================
   SALES OVERVIEW
======================================================= */

function computeSalesOverview(data) {
    let assigned = 0;
    let accepted = 0;
    let reverted = 0;
    let gsTransfer = 0;
    let coe = 0;

    const trendMonths = {};

    data.forEach(r => {
        const rep = r["Sales Rep"];
        const assignedDate = parseDate(r["Assigned Date"]);
        const revertedReason = r["Reason if Reverted"];
        const transferredDate = parseDate(r["Transferred to GS Date"]);
        const coeDate = parseDate(r["COE Obtained Date"]);

        if (assignedDate) assigned++;
        if (revertedReason && revertedReason.trim() !== "") reverted++;
        else accepted++;

        if (transferredDate) gsTransfer++;
        if (coeDate) coe++;

        if (assignedDate) {
            const key = `${assignedDate.getMonth()+1}/${assignedDate.getFullYear()}`;
            trendMonths[key] = (trendMonths[key] || 0) + 1;
        }
    });

    // Fix double-counting accepted
    accepted = assigned - reverted;

    // Update UI
    document.getElementById("valAssigned").textContent = assigned;
    document.getElementById("valAccepted").textContent = accepted;
    document.getElementById("valReverted").textContent = reverted;
    document.getElementById("valGSTransfer").textContent = gsTransfer;
    document.getElementById("valCOE").textContent = coe;

    drawBarChart("chartAssigned", trendMonths, "Assigned");
    drawBarChart("chartAccepted", trendMonths, "Accepted");
}

/* =======================================================
   SALES REP COMPARISON
======================================================= */

function computeSalesRep(data) {
    const reps = {};

    data.forEach(r => {
        const rep = r["Sales Rep"];
        if (!reps[rep]) reps[rep] = { assigned: 0, reverted: 0, gs: 0 };

        const assignedDate = parseDate(r["Assigned Date"]);
        const revertedReason = r["Reason if Reverted"];
        const transferredDate = parseDate(r["Transferred to GS Date"]);

        if (assignedDate) reps[rep].assigned++;
        if (revertedReason && revertedReason.trim() !== "") reps[rep].reverted++;
        if (transferredDate) reps[rep].gs++;
    });

    const labels = Object.keys(reps);
    const assignedData = labels.map(r => reps[r].assigned);
    const gsData = labels.map(r => reps[r].gs);

    drawBarChart("chartSalesRep", labelsToObj(labels, assignedData), "Assigned by Rep");
    drawBarChart("chartRepGSTransfer", labelsToObj(labels, gsData), "GS Transfers");
}

function labelsToObj(labels, dataset) {
    const out = {};
    labels.forEach((l, i) => out[l] = dataset[i]);
    return out;
}

/* =======================================================
   GS PERFORMANCE CALCULATIONS
======================================================= */

function computeGS(data) {
    const offerDaysArr = [];
    const coeDaysArr = [];
    const visaDaysArr = [];

    const offerTrend = {};
    const coeTrend = {};

    data.forEach(r => {
        const tgs = parseDate(r["Transferred to GS Date"]);
        const offer = parseDate(r["Full Offer Date"]);
        const coe = parseDate(r["COE Obtained Date"]);
        const visa = parseDate(r["Visa Lodged Date"]);

        // Transfer → Offer
        const d1 = daysBetween(tgs, offer);
        if (d1 !== null) {
            offerDaysArr.push(d1);
            const k = `${offer.getMonth()+1}/${offer.getFullYear()}`;
            offerTrend[k] = (offerTrend[k] || 0) + 1;
        }
        // Offer → COE
        const d2 = daysBetween(offer, coe);
        if (d2 !== null) {
            coeDaysArr.push(d2);
            const k = `${coe.getMonth()+1}/${coe.getFullYear()}`;
            coeTrend[k] = (coeTrend[k] || 0) + 1;
        }
        // COE → Visa
        const d3 = daysBetween(coe, visa);
        if (d3 !== null) visaDaysArr.push(d3);
    });

    const avg = arr => arr.length ? Math.round(arr.reduce((a,b)=>a+b)/arr.length) : 0;

    document.getElementById("valOfferDays").textContent = avg(offerDaysArr);
    document.getElementById("valCOEDays").textContent = avg(coeDaysArr);
    document.getElementById("valVisaDays").textContent = avg(visaDaysArr);

    drawBarChart("chartOffer", offerTrend, "Full Offers");
    drawBarChart("chartCOE", coeTrend, "COE Obtained");
}

/* =======================================================
   GS ALERTS
======================================================= */

function computeAlerts(data) {
    const tbody = document.querySelector("#alertTable tbody");
    tbody.innerHTML = "";

    data.forEach(r => {
        const tgs = parseDate(r["Transferred to GS Date"]);
        const offer = parseDate(r["Full Offer Date"]);
        const coe = parseDate(r["COE Obtained Date"]);
        const visa = parseDate(r["Visa Lodged Date"]);
        const gsLead = r["GS Lead"] || "";
        const client = r["Client Name"] || "N/A";

        let alertMsg = "";

        if (tgs && !offer && daysBetween(tgs, new Date()) > 10) {
            alertMsg = "Offer delayed";
        }
        if (offer && !coe && daysBetween(offer, new Date()) > 7) {
            alertMsg = "COE delayed";
        }
        if (coe && !visa && daysBetween(coe, new Date()) > 7) {
            alertMsg = "Visa Lodgement delayed";
        }

        if (alertMsg !== "") {
            tbody.innerHTML += `
                <tr>
                    <td>${client}</td>
                    <td>${gsLead}</td>
                    <td>${r["Transferred to GS Date"]}</td>
                    <td>${r["Full Offer Date"]}</td>
                    <td>${r["COE Obtained Date"]}</td>
                    <td>${r["Visa Lodged Date"]}</td>
                    <td style="color:#ff7676">${alertMsg}</td>
                </tr>`;
        }
    });
}

/* =======================================================
   DETAILS PAGE
======================================================= */

function populateDetails(data) {
    const tbody = document.querySelector("#detailsTable tbody");
    tbody.innerHTML = "";

    data.forEach(r => {
        tbody.innerHTML += `
        <tr>
            <td>${r["Sales Rep"]}</td>
            <td>${r["Assigned Date"]}</td>
            <td>${r["Transferred to GS Date"]}</td>
            <td>${r["COE Obtained Date"]}</td>
            <td>${r["GS Lead"]}</td>
        </tr>`;
    });
}

/* =======================================================
   CARD → FILTERED DETAILS NAVIGATION
======================================================= */

function goToDetails(filterField, filterValue) {
    const tbody = document.querySelector("#detailsTable tbody");
    tbody.innerHTML = "";

    window.rawData.forEach(r => {
        if (r[filterField] === filterValue || filterValue === "ALL") {
            tbody.innerHTML += `
                <tr>
                    <td>${r["Sales Rep"]}</td>
                    <td>${r["Assigned Date"]}</td>
                    <td>${r["Transferred to GS Date"]}</td>
                    <td>${r["COE Obtained Date"]}</td>
                    <td>${r["GS Lead"]}</td>
                </tr>`;
        }
    });

    showPage("details");
}

document.getElementById("cardAssigned").onclick = () => goToDetails("Assigned Date", "ALL");
document.getElementById("cardAccepted").onclick = () => goToDetails("Assigned Date", "ALL");
document.getElementById("cardReverted").onclick = () => goToDetails("Reason if Reverted", "ALL");
document.getElementById("cardGSTransfer").onclick = () => goToDetails("Transferred to GS Date", "ALL");
document.getElementById("cardCOE").onclick = () => goToDetails("COE Obtained Date", "ALL");

/* =======================================================
   CHART DRAWER
======================================================= */

function drawBarChart(canvasId, obj, label) {
    const labels = Object.keys(obj);
    const values = Object.values(obj);

    new Chart(document.getElementById(canvasId), {
        type: "bar",
        data: {
            labels: labels,
            datasets: [{
                label: label,
                data: values,
                backgroundColor: "#1c5eff",
                borderColor: "#5b8eff",
                borderWidth: 2,
                borderRadius: 6
            }]
        },
        options: {
            scales: {
                y: { beginAtZero: true }
            },
            responsive: true,
            maintainAspectRatio: false
        }
    });
}

/* =======================================================
   TAB SWITCHING LOGIC
======================================================= */

document.getElementById("tabSalesOverview").onclick = () => {
    document.getElementById("tabSalesOverview").classList.add("active");
    document.getElementById("tabSalesRep").classList.remove("active");

    document.getElementById("salesOverview").style.display = "block";
    document.getElementById("salesRepPage").style.display = "none";
};

document.getElementById("tabSalesRep").onclick = () => {
    document.getElementById("tabSalesOverview").classList.remove("active");
    document.getElementById("tabSalesRep").classList.add("active");

    document.getElementById("salesOverview").style.display = "none";
    document.getElementById("salesRepPage").style.display = "block";
};

document.getElementById("tabGSOverview").onclick = () => {
    document.getElementById("tabGSOverview").classList.add("active");
    document.getElementById("tabGSAlerts").classList.remove("active");

    document.getElementById("gsOverview").style.display = "block";
    document.getElementById("gsAlerts").style.display = "none";
};

document.getElementById("tabGSAlerts").onclick = () => {
    document.getElementById("tabGSOverview").classList.remove("active");
    document.getElementById("tabGSAlerts").classList.add("active");

    document.getElementById("gsOverview").style.display = "none";
    document.getElementById("gsAlerts").style.display = "block";
};

</script>
</body>
</html>
