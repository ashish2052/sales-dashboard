<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GSG ‚Äî Sales & GS Dashboard (API Powered)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<style>
:root {
  --bg:#f6f8fb;
  --panel:#fff;
  --panel2:#f3f6fb;
  --ink:#0f172a;
  --muted:#6b7280;
  --ok:#16a34a;
  --warn:#f59e0b;
  --bad:#ef4444;
  --border:#e5e7eb;
  --shadow:0 10px 30px rgba(2,6,23,.08);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:var(--bg);
  color:var(--ink);
  font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  display:flex;
}
aside{
  width:240px;background:#0b1220;color:#e5e7eb;
  border-right:1px solid rgba(255,255,255,.08);
  padding:18px;
  display:flex;
  flex-direction:column;
  gap:12px;
  position:sticky;
  top:0;
  height:100vh;
}
.logo{font-weight:800}
.side-btn{
  padding:10px 12px;
  border-radius:12px;
  background:#121a2b;
  border:1px solid rgba(255,255,255,.06);
  color:#d1d5db;
  cursor:pointer;
  text-align:left;
  transition:.15s;
}
.side-btn:hover{transform:translateY(-1px);background:#17213a}
.side-btn.active{
  background:linear-gradient(90deg,#3b82f6 0%,#22c55e 100%);
  color:#071225;font-weight:800;border-color:transparent;
}
main{flex:1;min-width:0}
.wrap{max-width:1400px;margin:0 auto;padding:22px}
header{display:flex;gap:16px;align-items:flex-end;justify-content:space-between;margin-bottom:10px}
h1{margin:0;font-size:24px}
.sub{color:var(--muted);font-size:12px}

.card{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:16px;
  padding:14px;
  box-shadow:var(--shadow);
}

.controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{
  padding:8px 12px;
  border-radius:10px;
  background:#eef2ff;
  border:1px solid #dbeafe;
  color:#1e293b;
  cursor:pointer;
}
.btn.active{
  background:#3b82f6;color:#fff;border-color:#3b82f6;font-weight:700;
}

.select,input[type=file],input[type=date],input[type=number]{
  background:#fff;border:1px solid var(--border);border-radius:10px;padding:8px 10px;
}

.tabs{display:flex;gap:8px;margin-top:12px}
.tab-btn{padding:8px 12px;border-radius:10px;background:#eef2ff;border:1px solid #dbeafe}
.tab-btn.active{background:#3b82f6;color:#fff;border-color:#3b82f6;font-weight:700}

.section{display:none}
.section.active{display:block}
.tab{display:none;margin-top:12px}
.tab.active{display:block}

.kpis{
  display:grid;
  grid-template-columns:repeat(6,1fr);
  gap:12px;
  margin:12px 0;
}
.kpi{padding:14px 16px;border-radius:14px;background:var(--panel2);border:1px solid var(--border)}
.kpi h3{margin:0 0 6px;font-size:12px;color:var(--muted)}
.big{font-size:26px;font-weight:800}

.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}

.table{
  overflow:auto;
  border-radius:12px;
  border:1px solid var(--border);
  margin-top:10px;
  background:#fff;
}
table{width:100%;border-collapse:separate;border-spacing:0}
th,td{
  padding:10px 12px;
  text-align:left;
  border-bottom:1px solid var(--border);
  white-space:nowrap;
  font-size:14px;
}
thead th{position:sticky;top:0;background:#f8fafc;color:#334155;font-size:12px}

.story{display:flex;gap:10px;flex-wrap:wrap;align-items:center;font-size:14px}
.story .chip{
  display:flex;gap:6px;align-items:center;padding:6px 10px;
  border:1px solid var(--border);border-radius:999px;background:#fff;
}

.pill{padding:3px 8px;border-radius:999px;font-weight:700;font-size:12px}
.p-ok{background:#ecfdf5;color:#065f46}
.p-warn{background:#fffbeb;color:#92400e}
.p-bad{background:#fef2f2;color:#991b1b}

canvas{
  background:#fff;border:1px solid var(--border);border-radius:12px;padding:8px;
}

@media(max-width:1200px){
  .kpis{grid-template-columns:1fr}
  .grid-2{grid-template-columns:1fr}
}
</style>
</head>

<body>
  <aside>
    <div class="logo">GSG ‚Äî KPI</div>
    <button class="side-btn active" data-dept="sales">üíº Sales</button>
    <button class="side-btn" data-dept="gs">üß© GS Team</button>
    <button class="side-btn" data-dept="bonus">üí∞ Bonus</button>
  </aside>

  <main>
    <div class="wrap">

<header>
  <div>
    <h1 id="title">Sales ‚Äî Dashboard</h1>
    <div class="sub">Connected to Cloudflare API ‚Üí automatic updates</div>
  </div>
  <div class="card"><div id="today"></div></div>
</header>

<div class="card controls">
  <span id="hint" class="sub">Loading data from API...</span>

  <span class="sub">Office:</span>
  <select id="officeSel" class="select">
    <option value="All">All</option>
    <option>Nepal</option>
    <option>Australia</option>
  </select>

  <span class="sub">Salesperson:</span>
  <select id="salesSel" class="select">
    <option>All</option>
  </select>

  <span class="sub">Date:</span>
  <div id="dateBtns" class="controls">
    <button class="btn active" data-range="all">All time</button>
    <button class="btn" data-range="90">Last 90d</button>
    <button class="btn" data-range="60">Last 60d</button>
    <button class="btn" data-range="30">Last 30d</button>
    <button class="btn" data-range="7">Last 7d</button>
  </div>

  <label>Custom: <input id="from" type="date"> ‚Äî <input id="to" type="date"></label>
  <button id="applyCustom" class="btn">Apply</button>
  <span class="sub" id="activeRange">Range: All time</span>
</div>

<!-- SALES -->
<section id="dept-sales" class="section active">
  <div class="tabs">
    <button class="tab-btn active" data-tab="sales-summary">Summary</button>
    <button class="tab-btn" data-tab="sales-reps">Salespersons</button>
  </div>

  <section id="sales-summary" class="tab active">
    <div id="sales_story" class="story card" style="margin-bottom:10px"></div>
    <div class="kpis" id="sales_kpis"></div>

    <div class="grid-2">
      <div class="card"><h3 style="margin:0">Transfers to GS ‚Äî Monthly</h3><canvas id="sales_trans_m" height="230"></canvas></div>
      <div class="card"><h3 style="margin:0">COEs ‚Äî Monthly</h3><canvas id="sales_coe_m" height="230"></canvas></div>
    </div>
  </section>

  <section id="sales-reps" class="tab">
    <div class="controls card" style="margin-bottom:10px">
      <span class="sub">Targets per rep: Nepal ‚Üí 15/mo; Australia ‚Üí 10/mo.</span>
    </div>
    <div class="table"><table id="sales_rep_tbl"><thead></thead><tbody></tbody></table></div>
  </section>
</section>
      <!-- =================== GS SECTION =================== -->
<section id="dept-gs" class="section">
  <div class="tabs">
    <button class="tab-btn active" data-tab="gs-summary">Summary</button>
    <button class="tab-btn" data-tab="gs-reps">GS Officers</button>
  </div>

  <section id="gs-summary" class="tab active">
    <div id="gs_story" class="story card" style="margin-bottom:10px"></div>
    <div class="kpis" id="gs_kpis"></div>

    <div class="grid-2">
      <div class="card"><h3 style="margin:0">Visa Grants ‚Äî Monthly</h3><canvas id="gs_visa_m" height="230"></canvas></div>
      <div class="card"><h3 style="margin:0">Visa Grant Rate ‚Äî Quarterly</h3><canvas id="gs_rate_q" height="230"></canvas></div>
    </div>
  </section>

  <section id="gs-reps" class="tab">
    <div class="controls card" style="margin-bottom:10px">
      <span class="sub">KPIs: COE/Assigned, Grant/Assigned, ‚â•90% grant rate goal.</span>
    </div>
    <div class="table"><table id="gs_rep_tbl"><thead></thead><tbody></tbody></table></div>
  </section>
</section>

<!-- =================== BONUS SECTION =================== -->
<section id="dept-bonus" class="section">
  <div class="tabs">
    <button class="tab-btn active" data-tab="bonus-qtr">Quarterly Eligibility</button>
  </div>

  <section id="bonus-qtr" class="tab active">
    <div class="controls card" style="margin-bottom:10px">
      <span class="sub">Quarter:</span>
      <select id="bonusQuarterSel" class="select"><option value="">Latest</option></select>
      <span class="sub">GS: ‚â•90% Grant Rate AND ‚â•25 Grants ‚Üí Eligible</span>
    </div>

    <div class="kpis" id="bonus_kpis"></div>

    <div class="grid-2">
      <div class="card">
        <h3 style="margin:0">Sales Bonus ‚Äî Nepal</h3>
        <div class="table" style="margin-top:8px">
          <table id="bonus_sales_np_tbl"><thead></thead><tbody></tbody></table>
        </div>
      </div>

      <div class="card">
        <h3 style="margin:0">Sales Bonus ‚Äî Australia</h3>
        <div class="table" style="margin-top:8px">
          <table id="bonus_sales_au_tbl"><thead></thead><tbody></tbody></table>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <h3 style="margin:0">GS Bonus</h3>
      <div class="table" style="margin-top:8px">
        <table id="bonus_gs_tbl"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </section>
</section>

</div> <!-- wrap -->
</main>

<!-- ========================= JAVASCRIPT ========================= -->
<script>
document.getElementById('today').textContent =
  new Date().toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'numeric'});

const API_URL = "https://salesdashboard.ashishoct34.workers.dev/";

let _wb = null;
let RANGE='all', CUSTOM=null, OFFICE='All', SALESPERSON='All', BONUS_Q=null;

/* Utility Functions */
const fmt = new Intl.NumberFormat('en-IN');
const num = n => isFinite(n) ? fmt.format(Math.round(n)) : '‚Äî';
const lc=s=>(s||'').toString().trim().toLowerCase();
const $  = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));

function toDate(v){
  if (v instanceof Date) return isNaN(v)?new Date(NaN):v;
  if (typeof v === 'number'){
    if (v < 20000) return new Date(NaN);
    const epoch=new Date(Date.UTC(1899,11,30));
    return new Date(epoch.getTime()+v*86400000);
  }
  const s=String(v||'').trim(); if(!s) return new Date(NaN);
  const m=s.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if(m) return new Date(+m[1],+m[2]-1,+m[3]);
  const d=new Date(s); return isNaN(d)?new Date(NaN):d;
}
const ymon=d=>d instanceof Date&&!isNaN(d)?`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`:'';
const quarterKey=d=>d instanceof Date&&!isNaN(d)?`${d.getFullYear()}-Q${Math.floor(d.getMonth()/3)+1}`:'';

function inRange(d,today){
  if(!(d instanceof Date)||isNaN(d)||d>today) return false;
  if(CUSTOM){
    const fd=new Date(CUSTOM[0]+'T00:00:00'),
          td=new Date(CUSTOM[1]+'T23:59:59');
    return d>=fd&&d<=td;
  }
  if(RANGE==='all') return true;
  const n=+RANGE, start=new Date(today); start.setDate(today.getDate()-n+1);
  return d>=start && d<=today;
}
function filterByDate(rows, field){
  const today=new Date();
  if(RANGE==='all'&&!CUSTOM) return rows.filter(r=>r[field] instanceof Date && !isNaN(r[field]));
  return rows.filter(r=>r[field] instanceof Date && inRange(r[field],today));
}

/* API Loader */
async function loadFromAPI(){
  try {
    $('#hint').textContent = "Fetching data from Cloudflare...";
    const res = await fetch(API_URL);
    const json = await res.json();
    const data = json.data;

    _wb = {
      Sweta: data.Sweta || [],
      Anusha: data.Anusha || [],
      Kumkum: data.Kumkum || []
    };

    $('#hint').textContent = "Loaded successfully.";

    populateSalesDropdown();
    rebuildQuarterDropdown();
    buildAll();

  } catch (e){
    $('#hint').textContent = "Error loading API: " + e.message;
  }
}
window.onload = loadFromAPI;

/* Field Mapping */
const H = {
  assignedOffice:['Assigned Office','Office'],
  assignee:['Assignee','Assigned To','Assigned'],
  salesRep:['Sales Rep','Sales Representative','Salesperson'],
  gsRep:['GS Lead','GS Rep','GS Officer'],
  reasonReverted:['Reason if Reverted','Reason','Reverted'],
  assignedDate:['Assigned Date'],
  tgs:['Transferred to GS Date'],
  fol:['Full Offer Date'],
  coe:['COE Obtained Date'],
  visaLodged:['Visa Lodged Date'],
  visa:['Visa Obtained Date']
};

function fuzzyKey(row, arr){
  const wantList=Array.isArray(arr)?arr:[arr];
  const keys=Object.keys(row);
  for(const w of wantList){
    const k=keys.find(h=>lc(h)===lc(w)); if(k) return k;
  }
  const toksList = wantList.map(w=>lc(w).split(/\s+/));
  for(const k of keys){
    const kl=lc(k);
    for(const toks of toksList){ if(toks.every(t=>kl.includes(t))) return k; }
  }
  return null;
}
function pick(row, list){
  const k=fuzzyKey(row, list);
  return k?row[k]:null;
}
function normalizeOffice(v){
  const s=String(v||'').toLowerCase();
  if(s.includes('aus')) return 'Australia';
  if(s.includes('nepal')||s.includes('np')) return 'Nepal';
  return s ? s[0].toUpperCase()+s.slice(1):'';
}

/* Convert rows */
function allRows(){
  const acc=[];
  Object.values(_wb||{}).forEach(arr=>{
    (arr||[]).forEach(r=>{
      const office=normalizeOffice(pick(r,H.assignedOffice));
      const assignee=(pick(r,H.assignee)||'').trim();
      const sales=(pick(r,H.salesRep)||'').trim()||'Unassigned';
      const gs=(pick(r,H.gsRep)||'').trim()||'Unassigned';
      const assigned=toDate(pick(r,H.assignedDate));
      const tgs=toDate(pick(r,H.tgs));
      const fol=toDate(pick(r,H.fol));
      const coe=toDate(pick(r,H.coe));
      const visaLodged=toDate(pick(r,H.visaLodged));
      const visa=toDate(pick(r,H.visa));
      const reverted=Boolean(pick(r,H.reasonReverted));

      if(OFFICE!=='All'&&office!==OFFICE) return;
      if(SALESPERSON!=='All'&&sales!==SALESPERSON) return;

      acc.push({office,assignee,salesRep:sales,gsRep:gs,assigned,tgs,fol,coe,visaLodged,visa,reverted});
    });
  });
  return acc;
}

/* Dropdowns */
function populateSalesDropdown(){
  const reps=new Set();
  Object.values(_wb||{}).forEach(arr=>{
    (arr||[]).forEach(r=>{
      const office=normalizeOffice(pick(r,H.assignedOffice));
      if(OFFICE!=='All'&&office!==OFFICE) return;
      const s=(pick(r,H.salesRep)||'').trim();
      if(s) reps.add(s);
    });
  });
  const sel=$('#salesSel'), cur=sel.value;
  sel.innerHTML=['All',...Array.from(reps).sort()]
    .map(n=>`<option${n===cur?' selected':''}>${n}</option>`).join('');
}
function rebuildQuarterDropdown(){
  const setQ=new Set();
  Object.values(_wb||{}).forEach(a=>{
    a.forEach(r=>{
      const co=toDate(pick(r,H.coe)), vl=toDate(pick(r,H.visaLodged)), v=toDate(pick(r,H.visa));
      if(co) setQ.add(quarterKey(co));
      if(vl) setQ.add(quarterKey(vl));
      if(v) setQ.add(quarterKey(v));
    });
  });
  const list=[...setQ].filter(Boolean).sort();
  const sel=$('#bonusQuarterSel');
  sel.innerHTML = `<option value="">Latest</option>` + list.map(q=>`<option>${q}</option>`).join('');
}

/* Sales Build */
let SCharts={mTrans:null,mCoe:null};
function sales_build(){
  const rows=allRows();
  const assigned=filterByDate(rows.filter(r=>r.assignee),'assigned');
  const reverted=filterByDate(rows.filter(r=>r.reverted),'assigned');
  const accepted=assigned.length - reverted.length;
  const transferred=filterByDate(rows.filter(r=>r.tgs),'tgs');
  const coes=filterByDate(rows.filter(r=>r.coe),'coe');

  $('#sales_story').innerHTML =
    `<span class="chip">üìÖ ${CUSTOM?`${CUSTOM[0]}‚Üí${CUSTOM[1]}`:(RANGE==='all'?'All time':'Last '+RANGE+'d')}</span>
     <span class="chip">üè¢ Office: ${OFFICE}</span>
     <span class="chip">üßë‚Äçüíº Sales: ${SALESPERSON}</span>`;

  $('#sales_kpis').innerHTML = `
    <div class="kpi"><h3>Assigned</h3><div class="big">${num(assigned.length)}</div></div>
    <div class="kpi"><h3>Accepted</h3><div class="big">${num(accepted)}</div></div>
    <div class="kpi"><h3>Reverted</h3><div class="big">${num(reverted.length)}</div></div>
    <div class="kpi"><h3>Transferred</h3><div class="big">${num(transferred.length)}</div></div>
    <div class="kpi"><h3>COEs</h3><div class="big">${num(coes.length)}</div></div>
    <div class="kpi"><h3>COE Rate</h3><div class="big">${assigned.length?(coes.length/assigned.length*100).toFixed(1):'0.0'}%</div></div>
  `;

  /* Charts */
  const byM_T={}, byM_C={};
  transferred.forEach(r=>{ const k=ymon(r.tgs); byM_T[k]=(byM_T[k]||0)+1; });
  coes.forEach(r=>{ const k=ymon(r.coe); byM_C[k]=(byM_C[k]||0)+1; });
  const mLabs=[...new Set([...Object.keys(byM_T),...Object.keys(byM_C)])].sort();

  if (SCharts.mTrans) SCharts.mTrans.destroy();
  SCharts.mTrans=new Chart($('#sales_trans_m'),{
    type:'bar',
    data:{labels:mLabs,datasets:[{label:'Transfers',data:mLabs.map(k=>byM_T[k]||0),backgroundColor:'#3b82f6',borderRadius:8}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  if (SCharts.mCoe) SCharts.mCoe.destroy();
  SCharts.mCoe=new Chart($('#sales_coe_m'),{
    type:'bar',
    data:{labels:mLabs,datasets:[{label:'COEs',data:mLabs.map(k=>byM_C[k]||0),backgroundColor:'#16a34a',borderRadius:8}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  renderSalesRepTable(rows);
}

/* Salesperson Table */
function renderSalesRepTable(rows){
  const byRep={};
  rows.forEach(r=>{
    const k=r.salesRep;
    byRep[k] ??= {office:r.office, assigned:0, reverted:0, transferred:0, coe:0};
    if(r.assignee) byRep[k].assigned++;
    if(r.reverted) byRep[k].reverted++;
    if(r.tgs)      byRep[k].transferred++;
    if(r.coe)      byRep[k].coe++;
  });

  const thead=`<tr>
    <th>Salesperson</th><th>Office</th><th>Assigned</th><th>Reverted</th><th>Accepted</th>
    <th>Transferred</th><th>COEs</th><th>COE/Assigned</th><th>Status</th>
  </tr>`;

  const tbody = Object.entries(byRep).map(([name,o])=>{
    const accepted=o.assigned-o.reverted;
    const rate=o.assigned?(o.coe/o.assigned*100).toFixed(1):'0.0';
    const st = rate >= 50 ? `<span class="pill p-ok">Good</span>` : `<span class="pill p-bad">Low</span>`;
    return `<tr>
      <td><b>${name}</b></td><td>${o.office||''}</td>
      <td>${num(o.assigned)}</td><td>${num(o.reverted)}</td><td>${num(accepted)}</td>
      <td>${num(o.transferred)}</td><td>${num(o.coe)}</td><td>${rate}%</td><td>${st}</td>
    </tr>`;
  }).join('');

  $('#sales_rep_tbl thead').innerHTML = thead;
  $('#sales_rep_tbl tbody').innerHTML = tbody || `<tr><td colspan="9">No Data</td></tr>`;
}

/* GS Build */
let GCharts={visaM:null,rateQ:null};
function gs_build(){
  const rows=allRows();
  const tgs=filterByDate(rows.filter(r=>r.tgs),'tgs');
  const fol=filterByDate(rows.filter(r=>r.fol),'fol');
  const coe=filterByDate(rows.filter(r=>r.coe),'coe');
  const lodged=filterByDate(rows.filter(r=>r.visaLodged),'visaLodged');
  const visa=filterByDate(rows.filter(r=>r.visa),'visa');

  const grantRate = lodged.length?(visa.length/lodged.length*100).toFixed(1):'0.0';

  $('#gs_story').innerHTML =
    `<span class="chip">üìÖ ${CUSTOM?`${CUSTOM[0]}‚Üí${CUSTOM[1]}`:(RANGE==='all'?'All time':'Last '+RANGE+'d')}</span>
     <span class="chip">GS Performance Overview</span>`;

  $('#gs_kpis').innerHTML = `
    <div class="kpi"><h3>Transfers Received</h3><div class="big">${num(tgs.length)}</div></div>
    <div class="kpi"><h3>Full Offers</h3><div class="big">${num(fol.length)}</div></div>
    <div class="kpi"><h3>COEs</h3><div class="big">${num(coe.length)}</div></div>
    <div class="kpi"><h3>Visa Lodged</h3><div class="big">${num(lodged.length)}</div></div>
    <div class="kpi"><h3>Visa Granted</h3><div class="big">${num(visa.length)}</div></div>
    <div class="kpi"><h3>Grant Rate</h3><div class="big">${grantRate}%</div></div>
  `;

  const mData={};
  visa.forEach(r=>{ const k=ymon(r.visa); mData[k]=(mData[k]||0)+1; });
  const mLabs=Object.keys(mData).sort();

  if(GCharts.visaM) GCharts.visaM.destroy();
  GCharts.visaM=new Chart($('#gs_visa_m'), {
    type:'bar',
    data:{labels:mLabs,datasets:[{label:'Visa Grants',data:mLabs.map(k=>mData[k]),backgroundColor:'#16a34a',borderRadius:8}]},
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}
  });

  renderGSRepTable(rows);
}

/* GS Officers */
function renderGSRepTable(rows){
  const by={};
  rows.forEach(r=>{
    const name=r.gsRep;
    if(!by[name]) by[name]={assigned:0,co:0,lodged:0,visa:0};
    if(r.tgs) by[name].assigned++;
    if(r.coe) by[name].co++;
    if(r.visaLodged) by[name].lodged++;
    if(r.visa) by[name].visa++;
  });

  const thead=`<tr>
    <th>GS Rep</th><th>Assigned</th><th>COEs</th>
    <th>Lodged</th><th>Granted</th><th>Rate</th>
  </tr>`;

  const tbody = Object.entries(by).map(([name,o])=>{
    const rate=o.lodged?(o.visa/o.lodged*100).toFixed(1):'0.0';
    return `<tr>
      <td><b>${name}</b></td>
      <td>${num(o.assigned)}</td><td>${num(o.co)}</td>
      <td>${num(o.lodged)}</td><td>${num(o.visa)}</td>
      <td>${rate}%</td>
    </tr>`;
  }).join('');

  $('#gs_rep_tbl thead').innerHTML = thead;
  $('#gs_rep_tbl tbody').innerHTML = tbody;
}

/* Bonus Build */
function bonus_build(){
  const rows=allRows();
  const qset=new Set();
  rows.forEach(r=>{
    if(r.coe) qset.add(quarterKey(r.coe));
    if(r.visaLodged) qset.add(quarterKey(r.visaLodged));
    if(r.visa) qset.add(quarterKey(r.visa));
  });
  const qs=[...qset].filter(Boolean).sort();
  const latest = qs[qs.length-1] || '';

  const Q = BONUS_Q || latest;

  $('#bonus_kpis').innerHTML =
    `<div class="kpi"><h3>Quarter</h3><div class="big">${Q}</div></div>
     <div class="kpi"><h3>GS Rule</h3><div class="big">‚â•25 Grants & ‚â•90% Rate</div></div>`;

  /* Sales Bonus */
  const salesAgg={};
  rows.forEach(r=>{
    if(r.coe && quarterKey(r.coe)===Q){
      const rep=r.salesRep, office=r.office;
      salesAgg[rep] ??= {office,co:0};
      salesAgg[rep].co++;
    }
  });

  const np = Object.entries(salesAgg).filter(([_,o])=>o.office==='Nepal');
  const au = Object.entries(salesAgg).filter(([_,o])=>o.office==='Australia');

  $('#bonus_sales_np_tbl thead').innerHTML =
    `<tr><th>Salesperson</th><th>Office</th><th>COEs</th><th>Eligible</th></tr>`;
  $('#bonus_sales_np_tbl tbody').innerHTML =
    np.map(([rep,o])=>{
      const ok=o.co>25;
      return `<tr><td>${rep}</td><td>${o.office}</td><td>${num(o.co)}</td><td>${ok?'Yes':'No'}</td></tr>`;
    }).join('') || `<tr><td colspan="4">No Nepal data</td></tr>`;

  $('#bonus_sales_au_tbl thead').innerHTML =
    `<tr><th>Salesperson</th><th>Office</th><th>COEs</th></tr>`;
  $('#bonus_sales_au_tbl tbody').innerHTML =
    au.map(([rep,o])=>{
      return `<tr><td>${rep}</td><td>${o.office}</td><td>${num(o.co)}</td></tr>`;
    }).join('') || `<tr><td colspan="3">No Australia data</td></tr>`;

  /* GS Bonus */
  const gsAgg={};
  rows.forEach(r=>{
    if(r.visaLodged && quarterKey(r.visaLodged)===Q){
      gsAgg[r.gsRep] ??= {lodged:0,visa:0};
      gsAgg[r.gsRep].lodged++;
    }
    if(r.visa && quarterKey(r.visa)===Q){
      gsAgg[r.gsRep] ??= {lodged:0,visa:0};
      gsAgg[r.gsRep].visa++;
    }
  });

  $('#bonus_gs_tbl thead').innerHTML =
    `<tr><th>GS Rep</th><th>Lodged</th><th>Granted</th><th>Eligible</th></tr>`;
  $('#bonus_gs_tbl tbody').innerHTML =
    Object.entries(gsAgg).map(([rep,o])=>{
      const rate=o.lodged?(o.visa/o.lodged*100):0;
      const ok=o.visa>=25 && rate>=90;
      return `<tr>
        <td>${rep}</td><td>${num(o.lodged)}</td><td>${num(o.visa)}</td>
        <td>${ok?'Yes':'No'}</td>
      </tr>`;
    }).join('') || `<tr><td colspan="4">No GS data</td></tr>`;
}

/* Navigation */
const sections={sales:'dept-sales',gs:'dept-gs',bonus:'dept-bonus'};
$$('.side-btn').forEach(b=>{
  b.onclick=()=>{
    $$('.side-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    Object.values(sections).forEach(id=>$('#'+id).classList.remove('active'));
    $('#'+sections[b.dataset.dept]).classList.add('active');
    $('#title').textContent = b.textContent.replace(/^[^\w]+/,'').trim()+' ‚Äî Dashboard';
  };
});
document.addEventListener('click',e=>{
  const btn=e.target.closest('.tab-btn');
  if(!btn) return;
  const host=btn.parentElement.parentElement;
  host.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));
  btn.classList.add('active');
  host.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
  host.querySelector('#'+btn.dataset.tab).classList.add('active');
});

/* Date filters */
$('#dateBtns').onclick=e=>{
  if(!e.target.classList.contains('btn')) return;
  $$('#dateBtns .btn').forEach(x=>x.classList.remove('active'));
  e.target.classList.add('active');
  RANGE=e.target.dataset.range;
  CUSTOM=null;
  if(_wb) buildAll();
};
$('#applyCustom').onclick=()=>{
  const f=$('#from').value, t=$('#to').value;
  if(f&&t){ CUSTOM=[f,t]; $$('#dateBtns .btn').forEach(x=>x.classList.remove('active')); if(_wb) buildAll(); }
};

/* Office & Salesperson */
$('#officeSel').onchange = e => { OFFICE=e.target.value; populateSalesDropdown(); if(_wb) buildAll(); };
$('#salesSel').onchange  = e => { SALESPERSON=e.target.value; if(_wb) buildAll(); };

/* Main Rebuild */
function buildAll(){ sales_build(); gs_build(); bonus_build(); }

</script>
</body>
</html>


