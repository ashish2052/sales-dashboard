<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sales & GS Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root {
    --bg: #050A1F;
    --card-bg: #0B1233;
    --text: #E6EEFF;
    --accent: #00C4FF;
    --green: #00ff99;
    --red: #ff4e6a;
    --yellow: #ffdd55;
}

body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: var(--bg);
    color: var(--text);
}

/* HEADER */
.header {
    background: rgba(0,0,0,0.35);
    padding: 20px 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #0E1A45;
    box-shadow: 0 0 25px #003388 inset;
}

.header-title {
    font-size: 30px;
    font-weight: 600;
    letter-spacing: 1px;
    color: #9EC5FF;
    text-shadow: 0 0 12px #007bff;
}

.live-btn {
    background: #0aff9d;
    padding: 8px 16px;
    border-radius: 8px;
    color: #052b1a;
    font-weight: 600;
    font-size: 15px;
    box-shadow: 0 0 12px #0aff9d;
}

/* LAYOUT */
.container {
    display: flex;
    height: calc(100vh - 75px);
}

/* SIDEBAR */
.sidebar {
    width: 250px;
    background: #081233;
    padding-top: 20px;
    border-right: 1px solid #0E1A45;
}

.sidebar button {
    width: 90%;
    margin: 10px auto;
    padding: 14px;
    background: #0B1233;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    color: var(--text);
    cursor: pointer;
    text-align: left;
    transition: 0.2s;
}

.sidebar button.active,
.sidebar button:hover {
    background: #10205a;
    box-shadow: 0 0 10px #0066ff;
}

/* CONTENT */
.content-area {
    flex: 1;
    padding: 25px;
    overflow-y: auto;
}

/* SUBTABS */
.subtabs {
    margin-bottom: 18px;
}

.subtabs button {
    margin-right: 12px;
    padding: 10px 16px;
    background: #0B1233;
    border-radius: 6px;
    color: var(--text);
    border: none;
    cursor: pointer;
}

.subtabs button.active {
    background: #003388;
    box-shadow: 0 0 8px #006eff;
}

/* CARDS */
.cards-row {
    display: flex;
    flex-wrap: wrap;
    gap: 18px;
    margin-bottom: 25px;
}

.card {
    background: var(--card-bg);
    padding: 18px;
    border-radius: 12px;
    width: 220px;
    box-shadow: 0 0 12px rgba(0,0,0,0.5);
    cursor: pointer;
    transition: 0.25s;
}

.card:hover {
    transform: translateY(-4px);
    box-shadow: 0 0 18px #008cff;
}

.card-title {
    font-size: 15px;
    opacity: 0.8;
}

.card-value {
    font-size: 28px;
    font-weight: 600;
    margin-top: 5px;
}

/* CHART GRID FIX — 2 per row */
.charts-row {
    width: 100%;
    display: flex;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 30px;
}

.chart-card {
    flex: 1;
    min-width: 48%;
    background: var(--card-bg);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 0 10px #0b0f2d;
}

/* DETAILS TABLE */
.table-box {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 0 14px #002255;
}

.table-box table {
    width: 100%;
    border-collapse: collapse;
    color: var(--text);
    font-size: 14px;
}

.table-box th, .table-box td {
    padding: 10px;
    border-bottom: 1px solid #1a2a55;
}

.row-alert { background: rgba(255, 0, 0, 0.15); }
.row-wait { background: rgba(255, 255, 0, 0.1); }
.row-ok { background: rgba(0, 255, 100, 0.08); }

/* HIDDEN SECTIONS */
.section { display: none; }
.section.active { display: block; }
</style>
</head>

<body>

<div class="header">
    <div class="header-title">Sales & GS Dashboard</div>
    <div class="live-btn">LIVE — Google Sheets</div>
</div>

<div class="container">

    <!-- SIDEBAR -->
    <div class="sidebar">
        <button id="btnSales" class="active">Sales</button>
        <button id="btnGS">GS Performance</button>
        <button id="btnDetails">Details</button>
    </div>

    <!-- CONTENT -->
    <div class="content-area">

        <!-- SALES SECTION -->
        <div id="sectionSales" class="section active">

            <div class="subtabs">
                <button id="tabSalesOverview" class="active">Sales Overview</button>
                <button id="tabSalesRep">Sales Rep</button>
            </div>

            <!-- SALES OVERVIEW -->
            <div id="salesOverview" class="subsection active">

                <div class="cards-row">
                    <div class="card" id="cardAssigned">
                        <div class="card-title">Assigned</div>
                        <div class="card-value" id="valAssigned">0</div>
                    </div>

                    <div class="card" id="cardAccepted">
                        <div class="card-title">Accepted</div>
                        <div class="card-value" id="valAccepted">0</div>
                    </div>

                    <div class="card" id="cardReverted">
                        <div class="card-title">Reverted</div>
                        <div class="card-value" id="valReverted">0</div>
                    </div>

                    <div class="card" id="cardGS">
                        <div class="card-title">Transferred to GS</div>
                        <div class="card-value" id="valGS">0</div>
                    </div>

                    <div class="card" id="cardCOE">
                        <div class="card-title">COE Obtained</div>
                        <div class="card-value" id="valCOE">0</div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-card">
                        <canvas id="chartAssignedTrend"></canvas>
                    </div>

                    <div class="chart-card">
                        <canvas id="chartAcceptedTrend"></canvas>
                    </div>
                </div>

            </div>

            <!-- SALES REP TAB -->
            <div id="salesRepPage" class="subsection">

                <!-- ACTIVE CLIENT CARDS -->
                <div class="cards-row">
                    <div class="card">
                        <div class="card-title">Sweta — Active Clients</div>
                        <div class="card-value" id="activeSweta">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Anusha — Active Clients</div>
                        <div class="card-value" id="activeAnusha">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Kumkum — Active Clients</div>
                        <div class="card-value" id="activeKumkum">0</div>
                    </div>
                </div>

                <!-- REP COMPARISON -->
                <div class="charts-row">
                    <div class="chart-card"><canvas id="chartRepAssigned"></canvas></div>
                    <div class="chart-card"><canvas id="chartRepGS"></canvas></div>
                </div>

                <!-- MONTHLY ROWS (6 charts total) -->
                <div class="charts-row">
                    <div class="chart-card"><canvas id="swetaAssignedMonthly"></canvas></div>
                    <div class="chart-card"><canvas id="swetaGSMonthly"></canvas></div>
                </div>

                <div class="charts-row">
                    <div class="chart-card"><canvas id="anushaAssignedMonthly"></canvas></div>
                    <div class="chart-card"><canvas id="anushaGSMonthly"></canvas></div>
                </div>

                <div class="charts-row">
                    <div class="chart-card"><canvas id="kumkumAssignedMonthly"></canvas></div>
                    <div class="chart-card"><canvas id="kumkumGSMonthly"></canvas></div>
                </div>

            </div>
        </div>

        <!-- GS PERFORMANCE SECTION -->
        <div id="sectionGS" class="section">

            <div class="subtabs">
                <button id="tabGSOverview" class="active">GS Overview</button>
                <button id="tabGSAlerts">Alerts</button>
            </div>

            <!-- GS MAIN OVERVIEW -->
            <div id="gsOverview" class="subsection active">

                <div class="cards-row">
                    <div class="card">
                        <div class="card-title">Total GS Cases</div>
                        <div class="card-value" id="gsTotal">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Pending Full Offer</div>
                        <div class="card-value" id="gsPendingOffer">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Pending COE</div>
                        <div class="card-value" id="gsPendingCOE">0</div>
                    </div>
                    <div class="card">
                        <div class="card-title">Pending Visa</div>
                        <div class="card-value" id="gsPendingVisa">0</div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-card"><canvas id="gsTransferTrend"></canvas></div>
                    <div class="chart-card"><canvas id="avgOfferDays"></canvas></div>
                </div>

                <div class="charts-row">
                    <div class="chart-card"><canvas id="avgCOEDays"></canvas></div>
                    <div class="chart-card"><canvas id="avgVisaDays"></canvas></div>
                </div>

            </div>

            <!-- GS ALERTS -->
            <div id="gsAlerts" class="subsection">

                <div class="table-box">
                    <table id="gsAlertsTable">
                        <thead>
                            <tr>
                                <th>Client</th>
                                <th>Stage</th>
                                <th>Days Stuck</th>
                                <th>GS Lead</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>

            </div>
        </div>

        <!-- DETAILS SECTION -->
        <div id="sectionDetails" class="section">
            <div class="table-box">
                <table id="detailsTable">
                    <thead>
                        <tr>
                            <th>Client Name</th>
                            <th>Agentcis Link</th>
                            <th>Assignee</th>
                            <th>Assigned Date</th>
                            <th>Source</th>
                            <th>Assigned Office</th>
                            <th>Sales Rep</th>
                            <th>Reason if Reverted</th>
                            <th>Transferred to GS Date</th>
                            <th>Full Offer Date</th>
                            <th>COE Obtained Date</th>
                            <th>Visa Lodged Date</th>
                            <th>Visa Obtained Date</th>
                            <th>GS Lead</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>

// ========== API URL ==========
const API_URL = "https://salesdashboard.ashishoct34.workers.dev/";

// Utility
function id(x){ return document.getElementById(x); }
function parseDate(d){
    if(!d) return null;
    let p = d.split("-");
    if(p.length < 3) return null;
    let year = parseInt(p[0]);
    let month = parseInt(p[1]) - 1;
    let day = parseInt(p[2]);
    return new Date(year, month, day);
}

// MAIN LOAD
let flatList = [];

async function loadData(){
    const res = await fetch(API_URL);
    const json = await res.json();

    const sweta = json.data.Sweta || [];
    const anusha = json.data.Anusha || [];
    const kumkum = json.data.Kumkum || [];

    flatList = [
        ...sweta,
        ...anusha,
        ...kumkum
    ];

    computeSalesOverview(flatList);
    computeSalesRep(flatList);
    computeGSOverview(flatList);
    computeGSAlerts(flatList);
    renderDetails(flatList);
}

/* -------------------------------
   SALES OVERVIEW METRICS
--------------------------------*/
function computeSalesOverview(list){
    let assigned = list.length;

    let reverted = list.filter(x => x["reason if reverted"]).length;

    let accepted = assigned - reverted;

    let gs = list.filter(x => x["transferred to gs date"]).length;

    let coe = list.filter(x => x["coe obtained date"]).length;

    id("valAssigned").textContent = assigned;
    id("valAccepted").textContent = accepted;
    id("valReverted").textContent = reverted;
    id("valGS").textContent = gs;
    id("valCOE").textContent = coe;
}

/* -------------------------------
    SALES REP LOGIC (Active + Monthly)
--------------------------------*/
function computeSalesRep(list){

    function activeCount(rep){
        return list.filter(x =>
            x["assignee"] &&
            x["assignee"].toLowerCase().includes(rep.toLowerCase()) &&
            !x["reason if reverted"] &&
            !x["transferred to gs date"]
        ).length;
    }

    id("activeSweta").textContent = activeCount("sweta");
    id("activeAnusha").textContent = activeCount("anusha");
    id("activeKumkum").textContent = activeCount("kumkum");

    // Monthly grouping
    function groupByMonth(arr, field){
        let map = {};
        arr.forEach(x=>{
            let d = parseDate(x[field]);
            if(!d) return;
            let key = d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
            if(!map[key]) map[key]=0;
            map[key]++;
        });
        return map;
    }

    let sA = groupByMonth(list.filter(x=>x.assignee?.includes("Sweta")),"assigned date");
    let sG = groupByMonth(list.filter(x=>x.assignee?.includes("Sweta")),"transferred to gs date");

    let aA = groupByMonth(list.filter(x=>x.assignee?.includes("Anusha")),"assigned date");
    let aG = groupByMonth(list.filter(x=>x.assignee?.includes("Anusha")),"transferred to gs date");

    let kA = groupByMonth(list.filter(x=>x.assignee?.includes("Kumkum")),"assigned date");
    let kG = groupByMonth(list.filter(x=>x.assignee?.includes("Kumkum")),"transferred to gs date");

    drawMonthlyCharts("swetaAssignedMonthly", sA);
    drawMonthlyCharts("swetaGSMonthly", sG);
    drawMonthlyCharts("anushaAssignedMonthly", aA);
    drawMonthlyCharts("anushaGSMonthly", aG);
    drawMonthlyCharts("kumkumAssignedMonthly", kA);
    drawMonthlyCharts("kumkumGSMonthly", kG);

    // Rep comparison
    let repAssigned = {
        Sweta: list.filter(x=>x.assignee?.includes("Sweta")).length,
        Anusha: list.filter(x=>x.assignee?.includes("Anusha")).length,
        Kumkum: list.filter(x=>x.assignee?.includes("Kumkum")).length
    };
    let repGS = {
        Sweta: list.filter(x=>x.assignee?.includes("Sweta") && x["transferred to gs date"]).length,
        Anusha: list.filter(x=>x.assignee?.includes("Anusha") && x["transferred to gs date"]).length,
        Kumkum: list.filter(x=>x.assignee?.includes("Kumkum") && x["transferred to gs date"]).length
    };

    drawBarComparison("chartRepAssigned", repAssigned, "Assigned per Rep");
    drawBarComparison("chartRepGS", repGS, "GS Transfers per Rep");
}

/* -------------------------------
    GS OVERVIEW
--------------------------------*/
function computeGSOverview(list){
    let gs = list.filter(x => x["transferred to gs date"]);

    id("gsTotal").textContent = gs.length;

    id("gsPendingOffer").textContent = gs.filter(x => !x["full offer date"]).length;
    id("gsPendingCOE").textContent = gs.filter(x => x["full offer date"] && !x["coe obtained date"]).length;
    id("gsPendingVisa").textContent = gs.filter(x => x["coe obtained date"] && !x["visa lodged date"]).length;

    drawMonthlyCharts("gsTransferTrend", 
        gs.reduce((acc,x)=>{
            let d=parseDate(x["transferred to gs date"]);
            if(d){
                let key=d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0");
                acc[key]=(acc[key]||0)+1;
            }
            return acc;
        },{}));

    drawAvgStageDays(list,"avgOfferDays","full offer date","transferred to gs date");
    drawAvgStageDays(list,"avgCOEDays","coe obtained date","full offer date");
    drawAvgStageDays(list,"avgVisaDays","visa lodged date","coe obtained date");
}

/* -------------------------------
    GS ALERTS
--------------------------------*/
function computeGSAlerts(list){
    const body = id("gsAlertsTable").querySelector("tbody");
    body.innerHTML = "";

    function diffDays(d1,d2){
        if(!d1 || !d2) return 0;
        return Math.floor((d1 - d2)/(1000*3600*24));
    }

    list.forEach(x=>{
        let stage="";
        let days=0;

        let tgs = parseDate(x["transferred to gs date"]);
        let full = parseDate(x["full offer date"]);
        let coe  = parseDate(x["coe obtained date"]);
        let visa = parseDate(x["visa lodged date"]);

        if(tgs && !full){
            stage="Waiting Full Offer";
            days=diffDays(new Date(), tgs);
        }
        else if(full && !coe){
            stage="Waiting COE";
            days=diffDays(new Date(), full);
        }
        else if(coe && !visa){
            stage="Waiting Visa Lodged";
            days=diffDays(new Date(), coe);
        }
        else{
            stage="Completed";
            days=0;
        }

        let cls="row-ok";
        if(days>=15) cls="row-alert";
        else if(days>=5) cls="row-wait";

        let tr=document.createElement("tr");
        tr.className=cls;
        tr.innerHTML=`
            <td>${x["client name"]||""}</td>
            <td>${stage}</td>
            <td>${days}</td>
            <td>${x["gs lead"]||""}</td>
        `;
        body.appendChild(tr);
    });
}

/* -------------------------------
    DETAILS TABLE
--------------------------------*/
function renderDetails(list){
    const body=id("detailsTable").querySelector("tbody");
    body.innerHTML="";

    list.forEach(x=>{
        let tr=document.createElement("tr");
        tr.innerHTML = `
            <td>${x["client name"]||""}</td>
            <td><a href="${x["agentcis link"]||"#"}" target="_blank">Open</a></td>
            <td>${x["assignee"]||""}</td>
            <td>${x["assigned date"]||""}</td>
            <td>${x["source"]||""}</td>
            <td>${x["assigned office"]||""}</td>
            <td>${x["sales rep"]||""}</td>
            <td>${x["reason if reverted"]||""}</td>
            <td>${x["transferred to gs date"]||""}</td>
            <td>${x["full offer date"]||""}</td>
            <td>${x["coe obtained date"]||""}</td>
            <td>${x["visa lodged date"]||""}</td>
            <td>${x["visa obtained date"]||""}</td>
            <td>${x["gs lead"]||""}</td>
        `;
        body.appendChild(tr);
    });
}

/* -------------------------------
   CHART DRAWING HELPERS
--------------------------------*/
function drawMonthlyCharts(canvasId, dataMap){
    const ctx=document.getElementById(canvasId);
    if(!ctx) return;

    new Chart(ctx,{
        type:"bar",
        data:{
            labels:Object.keys(dataMap),
            datasets:[{
                label:"Count",
                data:Object.values(dataMap),
                backgroundColor:"#008cff"
            }]
        },
        options:{responsive:true,plugins:{legend:{display:false}}}
    });
}

function drawBarComparison(canvasId, dataset, label){
    const ctx=id(canvasId);
    new Chart(ctx,{
        type:"bar",
        data:{
            labels:Object.keys(dataset),
            datasets:[{
                label,
                data:Object.values(dataset),
                backgroundColor:"#00C4FF"
            }]
        },
        options:{responsive:true}}
    );
}

function drawAvgStageDays(list,canvasId,fieldEnd,fieldStart){
    const ctx=id(canvasId);
    let arr=list.filter(x=>x[fieldEnd]&&x[fieldStart]);

    let total=0,count=0;
    arr.forEach(x=>{
        let d1=parseDate(x[fieldEnd]);
        let d2=parseDate(x[fieldStart]);
        if(d1&&d2){
            total+= (d1-d2)/(1000*3600*24);
            count++;
        }
    });

    new Chart(ctx,{
        type:"bar",
        data:{
            labels:["AVG Days"],
            datasets:[{
                data:[count? total/count : 0],
                backgroundColor:"#00C4FF"
            }]
        },
        options:{responsive:true,plugins:{legend:{display:false}}}
    });
}
    /* =====================================================
    CLICK → FILTER → GO TO DETAILS
=====================================================*/
function filterAndShowDetails(filterFn) {
    const filtered = flatList.filter(filterFn);
    renderDetails(filtered);
    openSection("sectionDetails");
}

/* CARD CLICKS (Sales Overview) */
id("cardAssigned").onclick = () => filterAndShowDetails(x => true);

id("cardAccepted").onclick = () =>
    filterAndShowDetails(x => !x["reason if reverted"]);

id("cardReverted").onclick = () =>
    filterAndShowDetails(x => x["reason if reverted"]);

id("cardGS").onclick = () =>
    filterAndShowDetails(x => x["transferred to gs date"]);

id("cardCOE").onclick = () =>
    filterAndShowDetails(x => x["coe obtained date"]);

/* SALES REP ACTIVE CARDS */
id("activeSweta").parentNode.onclick = () =>
    filterAndShowDetails(x =>
        x["assignee"]?.toLowerCase().includes("sweta") &&
        !x["reason if reverted"] &&
        !x["transferred to gs date"]
    );

id("activeAnusha").parentNode.onclick = () =>
    filterAndShowDetails(x =>
        x["assignee"]?.toLowerCase().includes("anusha") &&
        !x["reason if reverted"] &&
        !x["transferred to gs date"]
    );

id("activeKumkum").parentNode.onclick = () =>
    filterAndShowDetails(x =>
        x["assignee"]?.toLowerCase().includes("kumkum") &&
        !x["reason if reverted"] &&
        !x["transferred to gs date"]
    );


/* =====================================================
    TAB + SECTION SWITCHING
=====================================================*/

function openSection(idName) {
    document.querySelectorAll(".section").forEach(sec => sec.classList.remove("active"));
    id(idName).classList.add("active");

    document.querySelectorAll(".sidebar button").forEach(btn => btn.classList.remove("active"));
    if(idName === "sectionSales") id("btnSales").classList.add("active");
    if(idName === "sectionGS") id("btnGS").classList.add("active");
    if(idName === "sectionDetails") id("btnDetails").classList.add("active");
}

id("btnSales").onclick = () => {
    openSection("sectionSales");
    openSalesTab("salesOverview");
};

id("btnGS").onclick = () => {
    openSection("sectionGS");
    openGSTab("gsOverview");
};

id("btnDetails").onclick = () => {
    openSection("sectionDetails");
    renderDetails(flatList);
};


/* SALES SUBTABS */
function openSalesTab(tab) {
    id("tabSalesOverview").classList.remove("active");
    id("tabSalesRep").classList.remove("active");

    id("salesOverview").classList.remove("active");
    id("salesRepPage").classList.remove("active");

    if (tab === "salesOverview") {
        id("tabSalesOverview").classList.add("active");
        id("salesOverview").classList.add("active");
    } else {
        id("tabSalesRep").classList.add("active");
        id("salesRepPage").classList.add("active");
    }
}

id("tabSalesOverview").onclick = () => openSalesTab("salesOverview");
id("tabSalesRep").onclick = () => openSalesTab("salesRep");


/* GS SUBTABS */
function openGSTab(tab) {
    id("tabGSOverview").classList.remove("active");
    id("tabGSAlerts").classList.remove("active");

    id("gsOverview").classList.remove("active");
    id("gsAlerts").classList.remove("active");

    if (tab === "gsOverview") {
        id("tabGSOverview").classList.add("active");
        id("gsOverview").classList.add("active");
    } else {
        id("tabGSAlerts").classList.add("active");
        id("gsAlerts").classList.add("active");
    }
}

id("tabGSOverview").onclick = () => openGSTab("gsOverview");
id("tabGSAlerts").onclick = () => openGSTab("gsAlerts");


/* =====================================================
    DEFAULT LANDING PAGE
=====================================================*/
openSection("sectionSales");
openSalesTab("salesOverview");

/* =====================================================
    RUN THE DASHBOARD
=====================================================*/
loadData();


</script>
</body>
</html>

